<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trascrizione e Analisi Audio Avanzata</title>

    <!-- Librerie esportazione -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        /* RESET & BASE */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
            font-size: 28px;
        }
        .subtitle {
            text-align: center;
            color: #6b7280;
            margin-bottom: 30px;
            font-size: 14px;
        }

        /* TABS */
        .tabs { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 30px; 
            border-bottom: 2px solid #e5e7eb; 
            flex-wrap: wrap; 
        }
        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #6b7280;
            transition: all 0.3s;
        }
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* INFO BOX */
        .info-box {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        /* UPLOAD */
        .upload-area {
            border: 3px dashed #d1d5db;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .upload-area:hover {
            border-color: #667eea;
            background: #f9fafb;
        }
        .upload-area.dragover {
            border-color: #667eea;
            background: #eef2ff;
        }
        .upload-icon { font-size: 48px; margin-bottom: 10px; }

        /* BUTTONS */
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover:not(:disabled) { background: #5568d3; transform: translateY(-2px); }

        .btn-success { background: #10b981; color: white; }
        .btn-success:hover:not(:disabled) { background: #059669; }

        .btn-warning { background: #f59e0b; color: white; }
        .btn-warning:hover:not(:disabled) { background: #d97706; }

        .btn-secondary { background: #6b7280; color: white; }
        .btn-secondary:hover:not(:disabled) { background: #4b5563; }

        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover:not(:disabled) { background: #dc2626; }

        .btn.recording { 
            background: #ef4444; 
            animation: pulse 1.5s infinite; 
        }
        @keyframes pulse {
            0%,100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* TRANSCRIPTION AREA */
        .transcript-area {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            min-height: 300px;
            max-height: 500px;
            overflow-y: auto;
            margin-bottom: 20px;
            font-size: 16px;
            line-height: 1.8;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .transcript-area.empty {
            color: #9ca3af;
            font-style: italic;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* STATUS */
        .status {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
            display: none;
            align-items: center;
            gap: 10px;
        }
        .status.active { display: flex; }
        .status.success { background: #dcfce7; color: #166534; }
        .status.error { background: #fee2e2; color: #991b1b; }
        .status.info { background: #dbeafe; color: #1e40af; }
        .status.loading { background: #fef3c7; color: #92400e; }

        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ANALYSIS */
        .analysis-section {
            background: #f9fafb;
            border-left: 4px solid #667eea;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .analysis-section h3 {
            color: #667eea;
            margin-bottom: 10px;
        }
        .analysis-content {
            line-height: 1.6;
            color: #374151;
        }

        /* FORM ELEMENTS */
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #374151;
        }
        select, input[type="text"], input[type="password"], textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 15px;
            margin-bottom: 15px;
            transition: border-color 0.3s;
        }
        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        textarea {
            min-height: 200px;
            resize: vertical;
            font-family: inherit;
        }

        /* AUDIO PLAYER */
        audio {
            width: 100%;
            margin: 15px 0;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            h1 {
                font-size: 24px;
            }
            .btn {
                flex: 1;
                min-width: 120px;
            }
        }
    </style>
</head>
<body>
<div class="container">

<h1>üé§ Trascrizione e Analisi Audio Pro</h1>
<p class="subtitle">Trascrizione avanzata + analisi con AI</p>

<div id="status" class="status"></div>

<!-- TABS -->
<div class="tabs">
    <button class="tab active" data-tab="record">üéôÔ∏è Registra</button>
    <button class="tab" data-tab="upload">üìÅ Carica File</button>
    <button class="tab" data-tab="paste">üìù Incolla Testo</button>
    <button class="tab" data-tab="analysis">üîç Analisi</button>
</div>

<!-- TAB REGISTRAZIONE -->
<div class="tab-content active" id="tab-record">

    <div class="info-box" style="background:#fef3c7;border-left:4px solid #f59e0b;">
        üé§ <strong>Permessi microfono richiesti</strong><br>
        Clicca "Testa Microfono" se √® la prima volta che usi la pagina.
    </div>

    <div class="button-group">
        <button class="btn btn-warning" id="testMicBtn">üîä Testa Microfono</button>
    </div>

    <div id="microphoneStatus" style="display:none;padding:15px;border-radius:10px;margin-bottom:20px;font-weight:500;">
        <div id="micStatusText"></div>
        <div id="micVolumeMeter" style="margin-top:10px;display:none;">
            <div style="background:#e5e7eb;border-radius:5px;height:10px;overflow:hidden;">
                <div id="volumeBar" style="background:#10b981;height:100%;width:0%;transition:width .1s;"></div>
            </div>
        </div>
    </div>

    <div id="micInstructions" class="info-box" 
         style="display:none;background:#fee2e2;border-left:4px solid #ef4444;color:#991b1b;">
        ‚ùå <strong>Permesso microfono negato</strong><br>
        Per riattivarlo, clicca sull'icona del lucchetto nella barra degli indirizzi e consenti l'accesso al microfono.
    </div>

    <div style="margin-bottom:20px;">
        <label>Lingua di trascrizione:</label>
        <select id="language">
            <option value="it-IT">Italiano</option>
            <option value="en-US">Inglese (US)</option>
            <option value="en-GB">Inglese (UK)</option>
            <option value="es-ES">Spagnolo</option>
            <option value="fr-FR">Francese</option>
            <option value="de-DE">Tedesco</option>
        </select>
    </div>

    <div class="button-group">
        <button class="btn btn-success" id="recordBtn">
            <span id="recordBtnText">‚ñ∂Ô∏è Inizia Registrazione</span>
        </button>
        <button class="btn btn-secondary" id="resumeBtn" style="display:none;">
            ‚Ü©Ô∏è Riprendi Ultima Registrazione
        </button>
    </div>

    <div id="recordingStats" style="display:none;padding:10px;background:#dcfce7;border-radius:8px;margin-bottom:15px;text-align:center;font-weight:500;color:#166534;">
        <span id="wordCount">0 parole trascritte</span> ‚Ä¢ <span id="recordingTime">00:00</span>
    </div>

    <div class="transcript-area empty" id="liveTranscript">
        La trascrizione in tempo reale apparir√† qui...
    </div>

</div>

<!-- TAB CARICA FILE -->
<div class="tab-content" id="tab-upload">

    <div class="info-box" style="background:#d1fae5;border-left:4px solid #10b981;">
        üéß <strong>Carica un file audio</strong><br>
        Riproduci il file e la trascrizione avverr√† automaticamente.
    </div>

    <div class="upload-area" id="uploadArea">
        <div class="upload-icon">üì§</div>
        <h3>Trascina un file audio o clicca per caricare</h3>
        <p style="color:#6b7280;">Formati supportati: MP3, WAV, M4A, OGG, WebM</p>
        <input type="file" id="audioFile" accept="audio/*" style="display:none;">
    </div>

    <div id="audioFileName" style="padding:10px;background:#f3f4f6;border-radius:8px;margin-bottom:15px;display:none;"></div>

    <audio id="audioPlayer" controls style="display:none;"></audio>

    <div class="button-group">
        <button class="btn btn-primary" id="transcribeAudioBtn" disabled>üéØ Avvia Trascrizione</button>
        <button class="btn btn-danger" id="stopTranscriptionBtn" style="display:none;">‚èπÔ∏è Ferma</button>
    </div>

    <div class="transcript-area empty" id="liveFileTranscript" style="display:none;">
        Trascrizione in corso...
    </div>

</div>

<!-- TAB INCOLLA TESTO -->
<div class="tab-content" id="tab-paste">

    <div class="info-box" style="background:#dbeafe;border-left:4px solid #3b82f6;">
        üìù <strong>Incolla il testo</strong><br>
        Puoi incollare un testo gi√† trascritto per analizzarlo.
    </div>

    <label>Testo da analizzare:</label>
    <textarea id="pastedText" placeholder="Incolla qui il tuo testo..."></textarea>

    <div class="button-group">
        <button class="btn btn-primary" id="usePastedTextBtn">‚úÖ Usa Questo Testo</button>
    </div>

</div>

<!-- TAB ANALISI -->
<div class="tab-content" id="tab-analysis">

    <div class="info-box" style="background:#fef3c7;border-left:4px solid #f59e0b;" id="analysisInfo">
        ‚ö†Ô∏è <strong>Nessuna trascrizione disponibile</strong><br>
        Prima registra, carica un file o incolla del testo.
    </div>

    <div style="margin-bottom:20px;">
        <label>API Key Groq (opzionale - per analisi AI):</label>
        <input type="password" id="groqApiKey" placeholder="gsk_...">
        <small style="color:#6b7280;">Ottieni una chiave gratuita su <a href="https://console.groq.com" target="_blank">console.groq.com</a></small>
    </div>

    <h3 style="margin-bottom:15px;color:#374151;">üìÑ Trascrizione</h3>
    <div class="transcript-area" id="mainTranscript">
        Nessuna trascrizione disponibile.
    </div>

    <div class="button-group">
        <button class="btn btn-primary" id="correctTextBtn" disabled>‚ú® Correggi Testo</button>
        <button class="btn btn-primary" id="summarizeBtn" disabled>üìù Riassumi</button>
        <button class="btn btn-primary" id="analyzeBtn" disabled>üîç Analizza</button>
        <button class="btn btn-primary" id="identifySpeakersBtn" disabled>üë• Identifica Parlanti</button>
    </div>

    <div class="button-group">
        <button class="btn btn-success" id="exportPdfBtn" disabled>üìÑ Esporta PDF</button>
        <button class="btn btn-success" id="exportTxtBtn" disabled>üìù Esporta TXT</button>
        <button class="btn btn-danger" id="clearBtn">üóëÔ∏è Cancella Tutto</button>
    </div>

    <div id="analysisResults" style="margin-top:30px;"></div>

</div>

</div>

<script>
/* ===========================================
   VARIABILI GLOBALI
=========================================== */

// Elementi DOM
const tabs = document.querySelectorAll('.tab');
const tabContents = document.querySelectorAll('.tab-content');
const statusDiv = document.getElementById('status');

// Tab Registrazione
const testMicBtn = document.getElementById('testMicBtn');
const recordBtn = document.getElementById('recordBtn');
const resumeBtn = document.getElementById('resumeBtn');
const recordBtnText = document.getElementById('recordBtnText');
const liveTranscript = document.getElementById('liveTranscript');
const languageSelect = document.getElementById('language');
const microphoneStatus = document.getElementById('microphoneStatus');
const micStatusText = document.getElementById('micStatusText');
const micVolumeMeter = document.getElementById('micVolumeMeter');
const volumeBar = document.getElementById('volumeBar');
const micInstructions = document.getElementById('micInstructions');

// Recording stats
const recordingStats = document.getElementById('recordingStats');
const wordCount = document.getElementById('wordCount');
const recordingTime = document.getElementById('recordingTime');
let recordingStartTime = null;
let recordingInterval = null;

// Tab Upload
const uploadArea = document.getElementById('uploadArea');
const audioFileInput = document.getElementById('audioFile');
const audioFileName = document.getElementById('audioFileName');
const audioPlayer = document.getElementById('audioPlayer');
const transcribeAudioBtn = document.getElementById('transcribeAudioBtn');
const stopTranscriptionBtn = document.getElementById('stopTranscriptionBtn');
const liveFileTranscript = document.getElementById('liveFileTranscript');

// Tab Incolla
const pastedText = document.getElementById('pastedText');
const usePastedTextBtn = document.getElementById('usePastedTextBtn');

// Tab Analisi
const groqApiKey = document.getElementById('groqApiKey');
const mainTranscript = document.getElementById('mainTranscript');
const correctTextBtn = document.getElementById('correctTextBtn');
const summarizeBtn = document.getElementById('summarizeBtn');
const analyzeBtn = document.getElementById('analyzeBtn');
const identifySpeakersBtn = document.getElementById('identifySpeakersBtn');
const exportPdfBtn = document.getElementById('exportPdfBtn');
const exportTxtBtn = document.getElementById('exportTxtBtn');
const clearBtn = document.getElementById('clearBtn');
const analysisResults = document.getElementById('analysisResults');
const analysisInfo = document.getElementById('analysisInfo');

// Variabili stato
let recognition = null;
let isRecording = false;
let transcript = "";
let fileTranscript = "";
let fileTranscriptionActive = false;
let currentAudioFile = null;
let audioContext = null;
let analyser = null;
let microphone = null;

/* ===========================================
   INIZIALIZZAZIONE
=========================================== */

// Carica dati salvati
if (localStorage.getItem('transcript')) {
    const saved = localStorage.getItem('transcript');
    mainTranscript.textContent = saved;
    enableAnalysisButtons();
}

if (localStorage.getItem('groqKey')) {
    groqApiKey.value = localStorage.getItem('groqKey');
}

// Speech Recognition
if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
} else {
    showStatus('‚ùå Browser non supporta il riconoscimento vocale', 'error');
}

/* ===========================================
   GESTIONE TABS
=========================================== */

tabs.forEach(tab => {
    tab.addEventListener('click', () => {
        const targetTab = tab.dataset.tab;
        
        tabs.forEach(t => t.classList.remove('active'));
        tabContents.forEach(tc => tc.classList.remove('active'));
        
        tab.classList.add('active');
        document.getElementById(`tab-${targetTab}`).classList.add('active');
    });
});

/* ===========================================
   TEST MICROFONO
=========================================== */

testMicBtn.addEventListener('click', async () => {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        microphoneStatus.style.display = 'block';
        microphoneStatus.style.background = '#dcfce7';
        microphoneStatus.style.color = '#166534';
        micStatusText.textContent = '‚úÖ Microfono funzionante!';
        micVolumeMeter.style.display = 'block';
        
        // Analisi volume
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        microphone = audioContext.createMediaStreamSource(stream);
        microphone.connect(analyser);
        analyser.fftSize = 256;
        
        const dataArray = new Uint8Array(analyser.frequencyBinCount);
        
        function updateVolume() {
            analyser.getByteFrequencyData(dataArray);
            const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
            const volume = Math.min(100, (average / 128) * 100);
            volumeBar.style.width = volume + '%';
            
            if (micVolumeMeter.style.display !== 'none') {
                requestAnimationFrame(updateVolume);
            }
        }
        updateVolume();
        
        setTimeout(() => {
            stream.getTracks().forEach(track => track.stop());
            if (audioContext) audioContext.close();
            micVolumeMeter.style.display = 'none';
        }, 5000);
        
    } catch (err) {
        microphoneStatus.style.display = 'block';
        microphoneStatus.style.background = '#fee2e2';
        microphoneStatus.style.color = '#991b1b';
        micStatusText.textContent = '‚ùå Impossibile accedere al microfono';
        micInstructions.style.display = 'block';
    }
});

/* ===========================================
   REGISTRAZIONE VOCALE
=========================================== */

recordBtn.addEventListener('click', () => {
    if (!recognition) {
        showStatus('‚ùå Riconoscimento vocale non supportato', 'error');
        return;
    }
    
    if (!isRecording) {
        startRecording(false);
    } else {
        stopRecording();
    }
});

resumeBtn.addEventListener('click', () => {
    if (!recognition) {
        showStatus('‚ùå Riconoscimento vocale non supportato', 'error');
        return;
    }
    startRecording(true);
});

function startRecording(resume = false) {
    if (!resume) {
        transcript = "";
        liveTranscript.textContent = "";
        wordCount.textContent = "0 parole trascritte";
        resumeBtn.style.display = 'none';
    } else {
        // Riprendi dalla trascrizione precedente
        showStatus('‚Ü©Ô∏è Riprendendo la registrazione precedente...', 'info');
    }
    
    liveTranscript.classList.remove('empty');
    
    // Mostra statistiche
    recordingStats.style.display = 'block';
    recordingStartTime = Date.now();
    
    // Timer di registrazione
    recordingInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        recordingTime.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }, 1000);
    
    recognition.lang = languageSelect.value;
    recognition.interimResults = true;
    recognition.continuous = true;
    
    recognition.onresult = (event) => {
        let interimTranscript = "";
        
        for (let i = event.resultIndex; i < event.results.length; i++) {
            const transcriptPiece = event.results[i][0].transcript;
            
            if (event.results[i].isFinal) {
                transcript += transcriptPiece + " ";
                // Salva immediatamente il testo finale
                localStorage.setItem('transcript', transcript);
                
                // Aggiorna contatore parole
                const words = transcript.trim().split(/\s+/).length;
                wordCount.textContent = `${words} ${words === 1 ? 'parola trascritta' : 'parole trascritte'}`;
            } else {
                interimTranscript += transcriptPiece;
            }
        }
        
        liveTranscript.innerHTML = 
            transcript + 
            `<span style="color:#aaa;">${interimTranscript}</span>`;
        
        // Auto-scroll verso il basso
        liveTranscript.scrollTop = liveTranscript.scrollHeight;
    };
    
    recognition.onerror = (event) => {
        // Ignora errori di "no-speech" che sono normali durante pause
        if (event.error === 'no-speech') {
            return;
        }
        showStatus('‚ùå Errore: ' + event.error, 'error');
        if (event.error !== 'aborted') {
            stopRecording();
        }
    };
    
    recognition.onend = () => {
        // Riavvia automaticamente se sta ancora registrando
        if (isRecording) {
            try {
                recognition.start();
            } catch (err) {
                console.log('Tentativo di riavvio riconoscimento...');
                setTimeout(() => {
                    if (isRecording) {
                        recognition.start();
                    }
                }, 100);
            }
        }
    };
    
    try {
        recognition.start();
        isRecording = true;
        recordBtn.classList.add('recording');
        recordBtnText.textContent = '‚èπÔ∏è Ferma Registrazione';
        showStatus('üéôÔ∏è Registrazione in corso...', 'info');
    } catch (err) {
        showStatus('‚ùå Errore avvio registrazione', 'error');
    }
}

function stopRecording() {
    if (recognition) {
        recognition.stop();
    }
    
    isRecording = false;
    recordBtn.classList.remove('recording');
    recordBtnText.textContent = '‚ñ∂Ô∏è Inizia Registrazione';
    
    // Nascondi statistiche e ferma timer
    if (recordingInterval) {
        clearInterval(recordingInterval);
        recordingInterval = null;
    }
    setTimeout(() => {
        recordingStats.style.display = 'none';
    }, 2000);
    
    if (transcript.trim()) {
        // Mostra pulsante per riprendere
        resumeBtn.style.display = 'inline-flex';
        
        mainTranscript.textContent = transcript;
        localStorage.setItem('transcript', transcript);
        enableAnalysisButtons();
        
        const wordsFinal = transcript.trim().split(/\s+/).length;
        showStatus(`‚úÖ Registrazione completata! ${wordsFinal} parole trascritte.`, 'success');
        
        setTimeout(() => {
            tabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(tc => tc.classList.remove('active'));
            document.querySelector('[data-tab="analysis"]').classList.add('active');
            document.getElementById('tab-analysis').classList.add('active');
        }, 1000);
    }
}

/* ===========================================
   CARICA FILE AUDIO
=========================================== */

uploadArea.addEventListener('click', () => audioFileInput.click());

uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragover');
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    
    const file = e.dataTransfer.files[0];
    if (file && file.type.startsWith('audio/')) {
        handleAudioFile(file);
    } else {
        showStatus('‚ùå File non valido. Carica un file audio.', 'error');
    }
});

audioFileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) handleAudioFile(file);
});

function handleAudioFile(file) {
    audioFileName.style.display = 'block';
    audioFileName.textContent = `üìÅ ${file.name} (${(file.size/1048576).toFixed(2)} MB)`;
    
    const url = URL.createObjectURL(file);
    audioPlayer.src = url;
    audioPlayer.style.display = 'block';
    
    currentAudioFile = file;
    transcribeAudioBtn.disabled = false;
    
    showStatus('üìÅ File caricato. Clicca "Avvia Trascrizione".', 'success');
}

transcribeAudioBtn.addEventListener('click', transcribeAudioFile);

function transcribeAudioFile() {
    if (!recognition) {
        showStatus('‚ùå Riconoscimento vocale non supportato', 'error');
        return;
    }
    
    fileTranscript = "";
    liveFileTranscript.style.display = 'block';
    liveFileTranscript.classList.remove('empty');
    liveFileTranscript.textContent = "Trascrizione in corso...";
    
    recognition.lang = languageSelect.value;
    recognition.interimResults = true;
    recognition.continuous = true;
    
    recognition.onresult = (event) => {
        let interimTranscript = "";
        
        for (let i = event.resultIndex; i < event.results.length; i++) {
            const transcriptPiece = event.results[i][0].transcript;
            
            if (event.results[i].isFinal) {
                fileTranscript += transcriptPiece + " ";
                // Salva immediatamente
                localStorage.setItem('fileTranscript', fileTranscript);
            } else {
                interimTranscript += transcriptPiece;
            }
        }
        
        liveFileTranscript.innerHTML = 
            fileTranscript + 
            `<span style="color:#aaa;">${interimTranscript}</span>`;
        
        // Auto-scroll verso il basso
        liveFileTranscript.scrollTop = liveFileTranscript.scrollHeight;
    };
    
    recognition.onerror = (event) => {
        // Ignora errori di "no-speech" che sono normali durante pause
        if (event.error === 'no-speech') {
            return;
        }
        console.log('Errore riconoscimento:', event.error);
    };
    
    recognition.onend = () => {
        if (fileTranscriptionActive && !audioPlayer.paused) {
            try {
                recognition.start();
            } catch (err) {
                console.log('Tentativo di riavvio riconoscimento...');
                setTimeout(() => {
                    if (fileTranscriptionActive && !audioPlayer.paused) {
                        recognition.start();
                    }
                }, 100);
            }
        } else if (fileTranscriptionActive) {
            stopFileTranscription();
        }
    };
    
    audioPlayer.onended = () => stopFileTranscription();
    
    fileTranscriptionActive = true;
    transcribeAudioBtn.style.display = 'none';
    stopTranscriptionBtn.style.display = 'inline-flex';
    
    try {
        recognition.start();
        showStatus('üéß Trascrizione in corso...', 'info');
        
        setTimeout(() => {
            audioPlayer.currentTime = 0;
            audioPlayer.play();
        }, 600);
    } catch (err) {
        showStatus('‚ùå Errore avvio trascrizione', 'error');
    }
}

stopTranscriptionBtn.addEventListener('click', stopFileTranscription);

function stopFileTranscription() {
    fileTranscriptionActive = false;
    
    if (recognition) recognition.stop();
    audioPlayer.pause();
    audioPlayer.currentTime = 0;
    
    transcribeAudioBtn.style.display = 'inline-flex';
    stopTranscriptionBtn.style.display = 'none';
    
    if (fileTranscript.trim()) {
        mainTranscript.textContent = fileTranscript;
        localStorage.setItem('transcript', fileTranscript);
        enableAnalysisButtons();
        showStatus('üìÑ Trascrizione completata!', 'success');
        
        setTimeout(() => {
            tabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(tc => tc.classList.remove('active'));
            document.querySelector('[data-tab="analysis"]').classList.add('active');
            document.getElementById('tab-analysis').classList.add('active');
        }, 800);
    }
}

/* ===========================================
   INCOLLA TESTO
=========================================== */

usePastedTextBtn.addEventListener('click', () => {
    const text = pastedText.value.trim();
    if (!text) {
        showStatus('‚ö†Ô∏è Incolla del testo prima', 'error');
        return;
    }
    
    mainTranscript.textContent = text;
    localStorage.setItem('transcript', text);
    enableAnalysisButtons();
    showStatus('üìÑ Testo caricato!', 'success');
    
    setTimeout(() => {
        tabs.forEach(t => t.classList.remove('active'));
        tabContents.forEach(tc => tc.classList.remove('active'));
        document.querySelector('[data-tab="analysis"]').classList.add('active');
        document.getElementById('tab-analysis').classList.add('active');
    }, 800);
});

/* ===========================================
   FUNZIONI ANALISI AI (GROQ)
=========================================== */

function enableAnalysisButtons() {
    correctTextBtn.disabled = false;
    summarizeBtn.disabled = false;
    analyzeBtn.disabled = false;
    identifySpeakersBtn.disabled = false;
    exportPdfBtn.disabled = false;
    exportTxtBtn.disabled = false;
    analysisInfo.style.display = 'none';
}

async function callGroqAPI(prompt) {
    const key = groqApiKey.value.trim();
    if (!key) {
        showStatus('‚ùå Inserisci la tua API Key Groq', 'error');
        return null;
    }
    
    localStorage.setItem('groqKey', key);
    
    showStatus('ü§ñ Analisi AI in corso...', 'loading');
    
    try {
        const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${key}`,
            },
            body: JSON.stringify({
                model: 'llama-3.1-8b-instant',
                messages: [{ role: 'user', content: prompt }],
                temperature: 0.7,
                max_tokens: 4096,
            }),
        });
        
        if (!res.ok) {
            throw new Error(`Errore API: ${res.status}`);
        }
        
        const data = await res.json();
        return data.choices[0].message.content;
    } catch (err) {
        showStatus('‚ùå Errore Groq: ' + err.message, 'error');
        return null;
    }
}

/* ===== CORREZIONE TESTO ===== */
correctTextBtn.addEventListener('click', async () => {
    const text = mainTranscript.textContent.trim();
    if (!text) return;
    
    const prompt = `Correggi grammatica, punteggiatura e ortografia del seguente testo mantenendo il significato identico. Restituisci SOLO il testo corretto senza commenti:\n\n${text}`;
    
    const result = await callGroqAPI(prompt);
    if (!result) return;
    
    mainTranscript.textContent = result.trim();
    localStorage.setItem('transcript', result.trim());
    showStatus('‚ú® Testo corretto!', 'success');
});

/* ===== RIASSUNTO ===== */
summarizeBtn.addEventListener('click', async () => {
    const text = mainTranscript.textContent.trim();
    if (!text) return;
    
    const prompt = `Crea un riassunto strutturato del seguente testo in 5-7 punti chiave. Usa un formato chiaro con bullet points:\n\n${text}`;
    const result = await callGroqAPI(prompt);
    
    if (result) addAnalysisSection('üìù Riassunto', result);
});

/* ===== ANALISI COMPLETA ===== */
analyzeBtn.addEventListener('click', async () => {
    const text = mainTranscript.textContent.trim();
    if (!text) return;
    
    const prompt = `Analizza in modo approfondito il seguente testo. Includi:
1. Tema principale
2. Tono e stile
3. Punti chiave
4. Conclusioni o azioni da intraprendere

Testo:
${text}`;
    
    const result = await callGroqAPI(prompt);
    if (result) addAnalysisSection('üîç Analisi Completa', result);
});

/* ===== IDENTIFICAZIONE PARLANTI ===== */
identifySpeakersBtn.addEventListener('click', async () => {
    const text = mainTranscript.textContent.trim();
    if (!text) return;
    
    const prompt = `Analizza il seguente testo e identifica i possibili parlanti o interlocutori. Se sembrano esserci pi√π persone che parlano, suggerisci chi potrebbe dire cosa. Fornisci un'analisi chiara:\n\n${text}`;
    
    const result = await callGroqAPI(prompt);
    if (result) addAnalysisSection('üë• Identificazione Parlanti', result);
});

function addAnalysisSection(title, content) {
    const div = document.createElement('div');
    div.className = 'analysis-section';
    div.innerHTML = `<h3>${title}</h3><div class="analysis-content">${content.replace(/\n/g, '<br>')}</div>`;
    analysisResults.prepend(div);
    showStatus('‚ú® Analisi completata!', 'success');
}

/* ===========================================
   ESPORTAZIONE
=========================================== */

exportPdfBtn.addEventListener('click', () => {
    const text = mainTranscript.textContent.trim();
    if (!text) return;
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    const pageWidth = doc.internal.pageSize.getWidth();
    const margin = 15;
    const maxWidth = pageWidth - (margin * 2);
    
    doc.setFontSize(16);
    doc.text('Trascrizione Audio', margin, 20);
    
    doc.setFontSize(10);
    doc.text(`Data: ${new Date().toLocaleDateString('it-IT')}`, margin, 30);
    
    doc.setFontSize(12);
    const lines = doc.splitTextToSize(text, maxWidth);
    doc.text(lines, margin, 40);
    
    doc.save('trascrizione.pdf');
    showStatus('üìÑ PDF salvato!', 'success');
});

exportTxtBtn.addEventListener('click', () => {
    const text = mainTranscript.textContent.trim();
    if (!text) return;
    
    const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
    saveAs(blob, 'trascrizione.txt');
    showStatus('üìù TXT salvato!', 'success');
});

/* ===========================================
   CANCELLA TUTTO
=========================================== */

clearBtn.addEventListener('click', () => {
    if (!confirm('‚ö†Ô∏è Sei sicuro di voler cancellare tutto? Questa azione non pu√≤ essere annullata.')) {
        return;
    }
    
    localStorage.clear();
    mainTranscript.textContent = 'Nessuna trascrizione disponibile.';
    liveTranscript.textContent = 'La trascrizione in tempo reale apparir√† qui...';
    liveTranscript.classList.add('empty');
    liveFileTranscript.textContent = '';
    liveFileTranscript.style.display = 'none';
    pastedText.value = '';
    analysisResults.innerHTML = '';
    transcript = "";
    
    // Nascondi pulsante riprendi
    resumeBtn.style.display = 'none';
    
    correctTextBtn.disabled = true;
    summarizeBtn.disabled = true;
    analyzeBtn.disabled = true;
    identifySpeakersBtn.disabled = true;
    exportPdfBtn.disabled = true;
    exportTxtBtn.disabled = true;
    
    analysisInfo.style.display = 'block';
    
    showStatus('üóëÔ∏è Tutto cancellato!', 'info');
});

/* ===========================================
   FUNZIONE STATUS
=========================================== */

function showStatus(msg, type) {
    statusDiv.className = 'status active ' + type;
    statusDiv.innerHTML = 
        type === 'loading' 
        ? `<div class="spinner"></div><span>${msg}</span>`
        : msg;
    
    if (type !== 'loading') {
        setTimeout(() => statusDiv.classList.remove('active'), 4000);
    }
}

/* ===========================================
   SALVATAGGIO AUTOMATICO
=========================================== */

groqApiKey.addEventListener('input', () => {
    localStorage.setItem('groqKey', groqApiKey.value);
});

</script>

</body>
</html>
