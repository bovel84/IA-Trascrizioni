<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trascrizione e Analisi Audio Avanzata</title>

    <!-- Librerie esportazione -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        /* RESET & BASE */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
            font-size: 28px;
        }
        .subtitle {
            text-align: center;
            color: #6b7280;
            margin-bottom: 30px;
            font-size: 14px;
        }

        /* TABS */
        .tabs { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 30px; 
            border-bottom: 2px solid #e5e7eb; 
            flex-wrap: wrap; 
        }
        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #6b7280;
            transition: all 0.3s;
        }
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* INFO BOX */
        .info-box {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .info-box ol {
            color: inherit;
        }
        .info-box ol li {
            margin: 5px 0;
        }

        /* UPLOAD */
        .upload-area {
            border: 3px dashed #d1d5db;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .upload-area:hover {
            border-color: #667eea;
            background: #f9fafb;
        }
        .upload-area.dragover {
            border-color: #667eea;
            background: #eef2ff;
        }
        .upload-icon { font-size: 48px; margin-bottom: 10px; }

        /* BUTTONS */
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover:not(:disabled) { background: #5568d3; transform: translateY(-2px); }

        .btn-success { background: #10b981; color: white; }
        .btn-success:hover:not(:disabled) { background: #059669; }

        .btn-warning { background: #f59e0b; color: white; }
        .btn-warning:hover:not(:disabled) { background: #d97706; }

        .btn-secondary { background: #6b7280; color: white; }
        .btn-secondary:hover:not(:disabled) { background: #4b5563; }

        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover:not(:disabled) { background: #dc2626; }

        .btn.recording { 
            background: #ef4444; 
            animation: pulse 1.5s infinite; 
        }
        @keyframes pulse {
            0%,100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* TRANSCRIPTION AREA */
        .transcript-area {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            min-height: 300px;
            max-height: 500px;
            overflow-y: auto;
            margin-bottom: 20px;
            font-size: 16px;
            line-height: 1.8;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .transcript-area.empty {
            color: #9ca3af;
            font-style: italic;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* STATUS */
        .status {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
            display: none;
            align-items: center;
            gap: 10px;
        }
        .status.active { display: flex; }
        .status.success { background: #dcfce7; color: #166534; }
        .status.error { background: #fee2e2; color: #991b1b; }
        .status.info { background: #dbeafe; color: #1e40af; }
        .status.loading { background: #fef3c7; color: #92400e; }

        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ANALYSIS */
        .analysis-section {
            background: #f9fafb;
            border-left: 4px solid #667eea;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .analysis-section h3 {
            color: #667eea;
            margin-bottom: 10px;
        }
        .analysis-content {
            line-height: 1.6;
            color: #374151;
        }

        /* FORM ELEMENTS */
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #374151;
        }
        select, input[type="text"], input[type="password"], textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 15px;
            margin-bottom: 15px;
            transition: border-color 0.3s;
        }
        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        textarea {
            min-height: 200px;
            resize: vertical;
            font-family: inherit;
        }
        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #667eea;
        }

        .api-settings {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 2px solid #e5e7eb;
        }

        .api-settings small {
            display: block;
            margin-top: 5px;
        }

        /* AUDIO PLAYER */
        audio {
            width: 100%;
            margin: 15px 0;
        }

        /* SAVED RECORDINGS */
        .saved-list {
            background: #f9fafb;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        .saved-item {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }
        .saved-item:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }
        .saved-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .saved-item-title {
            font-weight: 600;
            color: #374151;
            font-size: 16px;
        }
        .saved-item-date {
            color: #6b7280;
            font-size: 13px;
        }
        .saved-item-text {
            color: #6b7280;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 10px;
            max-height: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .saved-item-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .btn-small {
            padding: 6px 12px;
            font-size: 13px;
        }

        /* WAKE LOCK INDICATOR */
        .wake-lock-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            display: none;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            z-index: 1000;
        }
        .wake-lock-indicator.active {
            display: flex;
        }
        .wake-lock-dot {
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            animation: blink 2s infinite;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            h1 {
                font-size: 22px;
            }
            .tabs {
                gap: 5px;
            }
            .tab {
                padding: 10px 16px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>

<!-- Wake Lock Indicator -->
<div class="wake-lock-indicator" id="wakeLockIndicator">
    <div class="wake-lock-dot"></div>
    Schermo attivo
</div>

<div class="container">
    <h1>üéôÔ∏è Trascrizione e Analisi Audio Avanzata</h1>
    <p class="subtitle">Registra, trascrivi e analizza audio con AI - Con salvataggio automatico</p>

    <div class="status" id="status"></div>

    <!-- TABS -->
    <div class="tabs">
        <button class="tab active" data-tab="live">üî¥ Registrazione Live</button>
        <button class="tab" data-tab="upload">üìÅ Carica File</button>
        <button class="tab" data-tab="paste">üìã Incolla Testo</button>
        <button class="tab" data-tab="analysis">üîç Analisi</button>
        <button class="tab" data-tab="saved">üíæ Salvati</button>
        <button class="tab" data-tab="settings">‚öôÔ∏è Impostazioni</button>
    </div>

    <!-- TAB: REGISTRAZIONE LIVE -->
    <div class="tab-content active" id="tab-live">
        <div class="info-box" style="background: #dbeafe; color: #1e40af;" id="apiKeyNoticeRec">
            ‚ö†Ô∏è <strong>Importante:</strong> Per usare la registrazione live, inserisci la tua API Key nella sezione Impostazioni per il servizio di trascrizione selezionato.
        </div>

        <div class="button-group">
            <button id="startBtn" class="btn btn-success">
                <span>üéôÔ∏è</span> Inizia Registrazione
            </button>
            <button id="pauseBtn" class="btn btn-warning" style="display:none;">
                <span>‚è∏Ô∏è</span> Pausa
            </button>
            <button id="resumeBtn" class="btn btn-warning" style="display:none;">
                <span>‚ñ∂Ô∏è</span> Riprendi
            </button>
            <button id="stopBtn" class="btn btn-danger" style="display:none;">
                <span>‚èπÔ∏è</span> Ferma
            </button>
            <label style="display: flex; align-items: center; gap: 8px; margin-left: auto;">
                <input type="checkbox" id="screenLockCheckbox" checked>
                <span style="font-size: 14px; color: #374151;">Mantieni schermo attivo</span>
            </label>
        </div>

        <div id="recordedAudioSection" style="display: none;">
            <label>üìº Audio Registrato:</label>
            <audio id="recordedAudio" controls></audio>
        </div>

        <label>üìù Trascrizione in Tempo Reale:</label>
        <div id="liveTranscript" class="transcript-area empty">
            La trascrizione in tempo reale apparir√† qui...
        </div>

        <div id="liveFileTranscript" style="display: none; margin-top: 20px;">
            <label>üìÑ Trascrizione Completa dal File Registrato:</label>
            <div id="liveFileTranscriptContent" class="transcript-area"></div>
        </div>

        <div class="button-group">
            <button id="saveRecordingBtn" class="btn btn-primary" style="display:none;">
                üíæ Salva Registrazione
            </button>
        </div>
    </div>

    <!-- TAB: CARICA FILE -->
    <div class="tab-content" id="tab-upload">
        <div class="info-box" style="background: #dbeafe; color: #1e40af;">
            <strong>Istruzioni:</strong>
            <ol>
                <li>Carica un file audio (MP3, WAV, M4A, WEBM, OGG - max 25MB)</li>
                <li>Il file verr√† trascritto usando Groq API</li>
                <li>La trascrizione apparir√† nella sezione Analisi</li>
            </ol>
        </div>

        <div id="uploadArea" class="upload-area">
            <div class="upload-icon">üìÅ</div>
            <p><strong>Trascina qui il file audio</strong></p>
            <p style="color: #6b7280; font-size: 14px;">oppure clicca per selezionare</p>
            <input type="file" id="audioFile" accept="audio/*" style="display: none;">
        </div>

        <div id="uploadedAudioSection" style="display: none;">
            <label>üéµ File Caricato:</label>
            <audio id="uploadedAudio" controls></audio>
            
            <div class="button-group" style="margin-top: 15px;">
                <button id="transcribeUploadBtn" class="btn btn-primary">
                    üéØ Trascrivi Audio
                </button>
                <button id="saveUploadedBtn" class="btn btn-success" style="display:none;">
                    üíæ Salva Trascrizione
                </button>
            </div>
        </div>

        <div id="uploadTranscriptSection" style="display: none; margin-top: 20px;">
            <label>üìù Trascrizione:</label>
            <div id="uploadTranscript" class="transcript-area"></div>
        </div>
    </div>

    <!-- TAB: INCOLLA TESTO -->
    <div class="tab-content" id="tab-paste">
        <div class="info-box" style="background: #fef3c7; color: #92400e;">
            üí° Puoi incollare qui un testo gi√† trascritto per analizzarlo senza dover registrare o caricare file audio.
        </div>

        <label>üìã Incolla il testo qui:</label>
        <textarea id="pastedText" placeholder="Incolla qui il tuo testo..."></textarea>

        <button id="usePastedTextBtn" class="btn btn-primary">
            ‚úÖ Usa questo testo
        </button>
    </div>

    <!-- TAB: ANALISI -->
    <div class="tab-content" id="tab-analysis">
        <div class="info-box" style="background: #dbeafe; color: #1e40af;" id="analysisInfo">
            ‚ÑπÔ∏è Prima registra, carica un file o incolla del testo per poterlo analizzare.
</div>

        <label>üìÑ Trascrizione Principale:</label>
        <div id="mainTranscript" class="transcript-area">Nessuna trascrizione disponibile.</div>

        <div class="button-group">
            <button id="correctTextBtn" class="btn btn-primary" disabled>
                ‚ú® Correggi Testo
            </button>
            <button id="summarizeBtn" class="btn btn-primary" disabled>
                üìù Riassumi
            </button>
            <button id="analyzeBtn" class="btn btn-primary" disabled>
                üîç Analisi Completa
            </button>
            <button id="identifySpeakersBtn" class="btn btn-primary" disabled>
                üë• Identifica Parlanti
            </button>
        </div>

        <div id="analysisResults"></div>

        <label style="margin-top: 20px;">üíæ Esporta Trascrizione:</label>
        <div class="button-group">
            <button id="exportPdfBtn" class="btn btn-secondary" disabled>
                üìÑ Esporta PDF
            </button>
            <button id="exportTxtBtn" class="btn btn-secondary" disabled>
                üìù Esporta TXT
            </button>
        </div>
    </div>

    <!-- TAB: SALVATI -->
    <div class="tab-content" id="tab-saved">
        <div class="info-box" style="background: #dcfce7; color: #166534;">
            üíæ Qui trovi tutte le conversazioni e registrazioni salvate. Puoi recuperarle, eliminarle o esportarle.
        </div>

        <div class="button-group">
            <button id="refreshSavedBtn" class="btn btn-primary">
                üîÑ Aggiorna Lista
            </button>
            <button id="clearAllSavedBtn" class="btn btn-danger">
                üóëÔ∏è Elimina Tutti
            </button>
        </div>

        <div id="savedList" class="saved-list"></div>
    </div>

    <!-- TAB: IMPOSTAZIONI -->
    <div class="tab-content" id="tab-settings">
        <div class="info-box" style="background: #fef3c7; color: #92400e;" id="apiKeyNotice">
            <strong>üîë API Key richiesta</strong><br>
            Seleziona un servizio di trascrizione e inserisci la relativa API Key per utilizzare le funzionalit√† di trascrizione audio.
        </div>

        <label>üéØ Servizio di Trascrizione Audio:</label>
        <select id="transcriptionService">
            <option value="groq">Groq Whisper (Veloce, Gratuito)</option>
            <option value="openai">OpenAI Whisper (Alta Qualit√†)</option>
            <option value="assemblyai">AssemblyAI (Professionale)</option>
        </select>

        <div id="groqSettings" class="api-settings">
            <label>üîë API Key Groq:</label>
            <input type="password" id="groqApiKey" placeholder="Inserisci la tua API Key Groq...">
            <small style="color: #6b7280;">Ottieni gratis su: <a href="https://console.groq.com" target="_blank" style="color: #667eea;">console.groq.com</a></small>
        </div>

        <div id="openaiSettings" class="api-settings" style="display: none;">
            <label>üîë API Key OpenAI:</label>
            <input type="password" id="openaiApiKey" placeholder="Inserisci la tua API Key OpenAI...">
            <small style="color: #6b7280;">Ottieni su: <a href="https://platform.openai.com" target="_blank" style="color: #667eea;">platform.openai.com</a></small>
        </div>

        <div id="assemblyaiSettings" class="api-settings" style="display: none;">
            <label>üîë API Key AssemblyAI:</label>
            <input type="password" id="assemblyaiApiKey" placeholder="Inserisci la tua API Key AssemblyAI...">
            <small style="color: #6b7280;">Ottieni su: <a href="https://www.assemblyai.com" target="_blank" style="color: #667eea;">assemblyai.com</a></small>
        </div>

        <label>üåê Lingua di Trascrizione:</label>
        <select id="languageSelect">
            <option value="it">üáÆüáπ Italiano</option>
            <option value="en">üá¨üáß English</option>
            <option value="es">üá™üá∏ Espa√±ol</option>
            <option value="fr">üá´üá∑ Fran√ßais</option>
            <option value="de">üá©üá™ Deutsch</option>
            <option value="pt">üáµüáπ Portugu√™s</option>
            <option value="nl">üá≥üá± Nederlands</option>
            <option value="pl">üáµüá± Polski</option>
            <option value="ru">üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
            <option value="zh">üá®üá≥ ‰∏≠Êñá</option>
            <option value="ja">üáØüáµ Êó•Êú¨Ë™û</option>
            <option value="ko">üá∞üá∑ ÌïúÍµ≠Ïñ¥</option>
        </select>

        <div class="button-group">
            <button id="clearBtn" class="btn btn-danger">
                üóëÔ∏è Cancella Tutto
            </button>
        </div>
    </div>
</div>

<script>
/* ===========================================
   VARIABILI GLOBALI
=========================================== */

const tabs = document.querySelectorAll('.tab');
const tabContents = document.querySelectorAll('.tab-content');

// Live Recording
const startBtn = document.getElementById('startBtn');
const pauseBtn = document.getElementById('pauseBtn');
const resumeBtn = document.getElementById('resumeBtn');
const stopBtn = document.getElementById('stopBtn');
const liveTranscript = document.getElementById('liveTranscript');
const recordedAudioSection = document.getElementById('recordedAudioSection');
const recordedAudio = document.getElementById('recordedAudio');
const liveFileTranscript = document.getElementById('liveFileTranscript');
const liveFileTranscriptContent = document.getElementById('liveFileTranscriptContent');
const saveRecordingBtn = document.getElementById('saveRecordingBtn');
const screenLockCheckbox = document.getElementById('screenLockCheckbox');
const wakeLockIndicator = document.getElementById('wakeLockIndicator');

// Upload
const uploadArea = document.getElementById('uploadArea');
const audioFile = document.getElementById('audioFile');
const uploadedAudioSection = document.getElementById('uploadedAudioSection');
const uploadedAudio = document.getElementById('uploadedAudio');
const transcribeUploadBtn = document.getElementById('transcribeUploadBtn');
const uploadTranscriptSection = document.getElementById('uploadTranscriptSection');
const uploadTranscript = document.getElementById('uploadTranscript');
const saveUploadedBtn = document.getElementById('saveUploadedBtn');

// Paste
const pastedText = document.getElementById('pastedText');
const usePastedTextBtn = document.getElementById('usePastedTextBtn');

// Analysis
const mainTranscript = document.getElementById('mainTranscript');
const correctTextBtn = document.getElementById('correctTextBtn');
const summarizeBtn = document.getElementById('summarizeBtn');
const analyzeBtn = document.getElementById('analyzeBtn');
const identifySpeakersBtn = document.getElementById('identifySpeakersBtn');
const analysisResults = document.getElementById('analysisResults');
const analysisInfo = document.getElementById('analysisInfo');
const exportPdfBtn = document.getElementById('exportPdfBtn');
const exportTxtBtn = document.getElementById('exportTxtBtn');

// Saved
const savedList = document.getElementById('savedList');
const refreshSavedBtn = document.getElementById('refreshSavedBtn');
const clearAllSavedBtn = document.getElementById('clearAllSavedBtn');

// Settings
const groqApiKey = document.getElementById('groqApiKey');
const openaiApiKey = document.getElementById('openaiApiKey');
const assemblyaiApiKey = document.getElementById('assemblyaiApiKey');
const transcriptionService = document.getElementById('transcriptionService');
const groqSettings = document.getElementById('groqSettings');
const openaiSettings = document.getElementById('openaiSettings');
const assemblyaiSettings = document.getElementById('assemblyaiSettings');
const languageSelect = document.getElementById('languageSelect');
const clearBtn = document.getElementById('clearBtn');

// Status
const statusDiv = document.getElementById('status');

// Recording State
let mediaRecorder = null;
let recognition = null;
let recordedChunks = [];
let recordedBlob = null;
let transcript = "";
let wakeLock = null;
let currentUploadedAudioBlob = null;
let currentUploadedFileName = '';

/* ===========================================
   INIZIALIZZAZIONE
=========================================== */

window.addEventListener('load', () => {
    // Carica API keys salvate
    const savedGroqKey = localStorage.getItem('groqKey');
    if (savedGroqKey) {
        groqApiKey.value = savedGroqKey;
    }
    
    const savedOpenAIKey = localStorage.getItem('openaiKey');
    if (savedOpenAIKey) {
        openaiApiKey.value = savedOpenAIKey;
    }
    
    const savedAssemblyAIKey = localStorage.getItem('assemblyaiKey');
    if (savedAssemblyAIKey) {
        assemblyaiApiKey.value = savedAssemblyAIKey;
    }
    
    // Carica servizio salvato
    const savedService = localStorage.getItem('transcriptionService') || 'groq';
    transcriptionService.value = savedService;
    updateTranscriptionSettings();
    
    // Carica lingua salvata
    const savedLang = localStorage.getItem('language') || 'it';
    languageSelect.value = savedLang;
    
    // Carica trascrizione salvata
    const savedTranscript = localStorage.getItem('transcript');
    if (savedTranscript) {
        mainTranscript.textContent = savedTranscript;
        enableAnalysisButtons();
    }
    
    // Carica lista salvati
    loadSavedList();
    
    // Nascondi notice se ci sono chiavi
    checkApiKeyNotices();
});

/* ===========================================
   TABS
=========================================== */

tabs.forEach(tab => {
    tab.addEventListener('click', () => {
        const target = tab.dataset.tab;
        
        tabs.forEach(t => t.classList.remove('active'));
        tabContents.forEach(tc => tc.classList.remove('active'));
        
        tab.classList.add('active');
        document.getElementById('tab-' + target).classList.add('active');
        
        if (target === 'saved') {
            loadSavedList();
        }
    });
});

/* ===========================================
   GESTIONE SERVIZI TRASCRIZIONE
=========================================== */

transcriptionService.addEventListener('change', () => {
    localStorage.setItem('transcriptionService', transcriptionService.value);
    updateTranscriptionSettings();
    checkApiKeyNotices();
});

function updateTranscriptionSettings() {
    // Nascondi tutte le sezioni
    groqSettings.style.display = 'none';
    openaiSettings.style.display = 'none';
    assemblyaiSettings.style.display = 'none';
    
    // Mostra la sezione selezionata
    const service = transcriptionService.value;
    if (service === 'groq') {
        groqSettings.style.display = 'block';
    } else if (service === 'openai') {
        openaiSettings.style.display = 'block';
    } else if (service === 'assemblyai') {
        assemblyaiSettings.style.display = 'block';
    }
}

function checkApiKeyNotices() {
    const service = transcriptionService.value;
    let hasKey = false;
    
    if (service === 'groq' && groqApiKey.value.trim()) {
        hasKey = true;
    } else if (service === 'openai' && openaiApiKey.value.trim()) {
        hasKey = true;
    } else if (service === 'assemblyai' && assemblyaiApiKey.value.trim()) {
        hasKey = true;
    }
    
    const apiKeyNotice = document.getElementById('apiKeyNotice');
    const apiKeyNoticeRec = document.getElementById('apiKeyNoticeRec');
    
    if (hasKey) {
        if (apiKeyNotice) apiKeyNotice.style.display = 'none';
        if (apiKeyNoticeRec) apiKeyNoticeRec.style.display = 'none';
    } else {
        if (apiKeyNotice) apiKeyNotice.style.display = 'block';
        if (apiKeyNoticeRec) apiKeyNoticeRec.style.display = 'block';
    }
}

/* ===========================================
   WAKE LOCK API - SCHERMO ATTIVO
=========================================== */

async function requestWakeLock() {
    if (!screenLockCheckbox.checked) return;
    
    if ('wakeLock' in navigator) {
        try {
            wakeLock = await navigator.wakeLock.request('screen');
            wakeLockIndicator.classList.add('active');
            console.log('Wake Lock attivato');
            
            wakeLock.addEventListener('release', () => {
                console.log('Wake Lock rilasciato');
                wakeLockIndicator.classList.remove('active');
            });
        } catch (err) {
            console.error('Errore Wake Lock:', err);
            showStatus('‚ö†Ô∏è Impossibile mantenere lo schermo attivo', 'error');
        }
    } else {
        showStatus('‚ö†Ô∏è Wake Lock non supportato su questo browser', 'error');
    }
}

async function releaseWakeLock() {
    if (wakeLock) {
        try {
            await wakeLock.release();
            wakeLock = null;
            wakeLockIndicator.classList.remove('active');
        } catch (err) {
            console.error('Errore rilascio Wake Lock:', err);
        }
    }
}

// Riattiva wake lock quando la pagina diventa visibile
document.addEventListener('visibilitychange', async () => {
    if (wakeLock !== null && document.visibilityState === 'visible') {
        await requestWakeLock();
    }
});

/* ===========================================
   REGISTRAZIONE LIVE
=========================================== */

startBtn.addEventListener('click', async () => {
    try {
        // Richiedi permessi microfono
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        // Attiva Wake Lock
        await requestWakeLock();
        
        // Inizia registrazione audio
        mediaRecorder = new MediaRecorder(stream);
        recordedChunks = [];
        
        mediaRecorder.ondataavailable = e => {
            if (e.data.size > 0) {
                recordedChunks.push(e.data);
            }
        };
        
        mediaRecorder.onstop = () => {
            recordedBlob = new Blob(recordedChunks, { type: 'audio/webm' });
            const url = URL.createObjectURL(recordedBlob);
            recordedAudio.src = url;
            recordedAudioSection.style.display = 'block';
            saveRecordingBtn.style.display = 'inline-flex';
            
            // Trascrivi automaticamente il file registrato
            transcribeRecordedAudio();
        };
        
        mediaRecorder.start();
        
        // Inizia riconoscimento vocale
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = languageSelect.value;
            
            recognition.onresult = e => {
                let interimTranscript = '';
                let finalTranscript = '';
                
                for (let i = e.resultIndex; i < e.results.length; i++) {
                    const t = e.results[i][0].transcript;
                    if (e.results[i].isFinal) {
                        finalTranscript += t + ' ';
                    } else {
                        interimTranscript += t;
                    }
                }
                
                transcript += finalTranscript;
                liveTranscript.textContent = transcript + interimTranscript;
                liveTranscript.classList.remove('empty');
            };
            
            recognition.start();
        }
        
        // Aggiorna UI
        startBtn.style.display = 'none';
        pauseBtn.style.display = 'inline-flex';
        stopBtn.style.display = 'inline-flex';
        startBtn.classList.add('recording');
        
        showStatus('üéôÔ∏è Registrazione in corso...', 'info');
    } catch (err) {
        showStatus('‚ùå Errore: ' + err.message, 'error');
        await releaseWakeLock();
    }
});

pauseBtn.addEventListener('click', () => {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.pause();
    }
    if (recognition) {
        recognition.stop();
    }
    
    pauseBtn.style.display = 'none';
    resumeBtn.style.display = 'inline-flex';
    showStatus('‚è∏Ô∏è Registrazione in pausa', 'info');
});

resumeBtn.addEventListener('click', () => {
    if (mediaRecorder && mediaRecorder.state === 'paused') {
        mediaRecorder.resume();
    }
    if (recognition) {
        recognition.start();
    }
    
    resumeBtn.style.display = 'none';
    pauseBtn.style.display = 'inline-flex';
    showStatus('‚ñ∂Ô∏è Registrazione ripresa', 'info');
});

stopBtn.addEventListener('click', async () => {
    if (mediaRecorder) {
        mediaRecorder.stop();
        mediaRecorder.stream.getTracks().forEach(track => track.stop());
    }
    if (recognition) {
        recognition.stop();
    }
    
    // Rilascia Wake Lock
    await releaseWakeLock();
    
    // Aggiorna UI
    startBtn.style.display = 'inline-flex';
    pauseBtn.style.display = 'none';
    stopBtn.style.display = 'none';
    resumeBtn.style.display = 'none';
    startBtn.classList.remove('recording');
    
    // Salva trascrizione in tempo reale
    mainTranscript.textContent = transcript;
    localStorage.setItem('transcript', transcript);
    enableAnalysisButtons();
    
    showStatus('‚úÖ Registrazione completata!', 'success');
});

/* ===========================================
   TRASCRIZIONE FILE REGISTRATO
=========================================== */

async function transcribeRecordedAudio() {
    if (!recordedBlob) return;
    
    showStatus('üéØ Trascrizione del file in corso...', 'loading');
    
    try {
        const result = await transcribeAudioBlob(recordedBlob, 'registrazione.webm');
        
        if (result) {
            liveFileTranscriptContent.textContent = result;
            liveFileTranscript.style.display = 'block';
            
            // Combina con trascrizione live
            const combinedTranscript = transcript + '\n\n' + result;
            mainTranscript.textContent = combinedTranscript;
            localStorage.setItem('transcript', combinedTranscript);
            enableAnalysisButtons();
            
            showStatus('‚úÖ Trascrizione completata!', 'success');
        }
    } catch (err) {
        showStatus('‚ùå Errore trascrizione: ' + err.message, 'error');
    }
}

/* ===========================================
   SALVATAGGIO REGISTRAZIONE
=========================================== */

saveRecordingBtn.addEventListener('click', () => {
    const savedData = {
        id: Date.now(),
        date: new Date().toLocaleString('it-IT'),
        type: 'recording',
        transcript: mainTranscript.textContent,
        audioBlob: recordedBlob ? blobToBase64(recordedBlob) : null
    };
    
    saveToStorage(savedData);
    showStatus('üíæ Registrazione salvata!', 'success');
    loadSavedList();
});

/* ===========================================
   UPLOAD FILE AUDIO
=========================================== */

uploadArea.addEventListener('click', () => audioFile.click());

uploadArea.addEventListener('dragover', e => {
    e.preventDefault();
    uploadArea.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragover');
});

uploadArea.addEventListener('drop', e => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    const file = e.dataTransfer.files[0];
    if (file) handleAudioFile(file);
});

audioFile.addEventListener('change', e => {
    const file = e.target.files[0];
    if (file) handleAudioFile(file);
});

function handleAudioFile(file) {
    if (!file.type.startsWith('audio/')) {
        showStatus('‚ùå Per favore carica un file audio', 'error');
        return;
    }
    
    if (file.size > 25 * 1024 * 1024) {
        showStatus('‚ùå File troppo grande! Max 25MB', 'error');
        return;
    }
    
    const url = URL.createObjectURL(file);
    uploadedAudio.src = url;
    uploadedAudioSection.style.display = 'block';
    currentUploadedFileName = file.name;
    
    // Salva il blob per trascrizione successiva
    currentUploadedAudioBlob = file;
    
    showStatus('üìÅ File caricato! Clicca "Trascrivi Audio"', 'success');
}

transcribeUploadBtn.addEventListener('click', async () => {
    if (!currentUploadedAudioBlob) {
        showStatus('‚ùå Nessun file caricato', 'error');
        return;
    }
    
    showStatus('üéØ Trascrizione in corso...', 'loading');
    
    try {
        const result = await transcribeAudioBlob(currentUploadedAudioBlob, currentUploadedFileName);
        
        if (result) {
            uploadTranscript.textContent = result;
            uploadTranscriptSection.style.display = 'block';
            saveUploadedBtn.style.display = 'inline-flex';
            
            mainTranscript.textContent = result;
            localStorage.setItem('transcript', result);
            enableAnalysisButtons();
            
            showStatus('‚úÖ Trascrizione completata!', 'success');
            
            setTimeout(() => {
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(tc => tc.classList.remove('active'));
                document.querySelector('[data-tab="analysis"]').classList.add('active');
                document.getElementById('tab-analysis').classList.add('active');
            }, 800);
        }
    } catch (err) {
        showStatus('‚ùå Errore: ' + err.message, 'error');
    }
});

saveUploadedBtn.addEventListener('click', async () => {
    const audioBase64 = currentUploadedAudioBlob ? await blobToBase64(currentUploadedAudioBlob) : null;
    
    const savedData = {
        id: Date.now(),
        date: new Date().toLocaleString('it-IT'),
        type: 'upload',
        fileName: currentUploadedFileName,
        transcript: uploadTranscript.textContent,
        audioBlob: audioBase64
    };
    
    saveToStorage(savedData);
    showStatus('üíæ Trascrizione salvata!', 'success');
    loadSavedList();
});

/* ===========================================
   TRASCRIZIONE AUDIO CON MULTIPLI SERVIZI
=========================================== */

async function transcribeAudioBlob(blob, fileName) {
    const service = transcriptionService.value;
    
    if (service === 'groq') {
        return await transcribeWithGroq(blob, fileName);
    } else if (service === 'openai') {
        return await transcribeWithOpenAI(blob, fileName);
    } else if (service === 'assemblyai') {
        return await transcribeWithAssemblyAI(blob, fileName);
    }
}

/* ===== GROQ WHISPER ===== */
async function transcribeWithGroq(blob, fileName) {
    const key = groqApiKey.value.trim();
    if (!key) {
        showStatus('‚ùå Inserisci la tua API Key Groq', 'error');
        return null;
    }
    
    localStorage.setItem('groqKey', key);
    
    try {
        const formData = new FormData();
        formData.append('file', blob, fileName);
        formData.append('model', 'whisper-large-v3');
        formData.append('language', languageSelect.value);
        formData.append('response_format', 'json');
        
        const res = await fetch('https://api.groq.com/openai/v1/audio/transcriptions', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${key}`,
            },
            body: formData
        });
        
        if (!res.ok) {
            const errorText = await res.text();
            throw new Error(`Errore API Groq (${res.status}): ${errorText}`);
        }
        
        const data = await res.json();
        return data.text;
    } catch (err) {
        throw err;
    }
}

/* ===== OPENAI WHISPER ===== */
async function transcribeWithOpenAI(blob, fileName) {
    const key = openaiApiKey.value.trim();
    if (!key) {
        showStatus('‚ùå Inserisci la tua API Key OpenAI', 'error');
        return null;
    }
    
    localStorage.setItem('openaiKey', key);
    
    try {
        const formData = new FormData();
        formData.append('file', blob, fileName);
        formData.append('model', 'whisper-1');
        formData.append('language', languageSelect.value);
        formData.append('response_format', 'json');
        
        const res = await fetch('https://api.openai.com/v1/audio/transcriptions', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${key}`,
            },
            body: formData
        });
        
        if (!res.ok) {
            const errorData = await res.json();
            throw new Error(`Errore API OpenAI (${res.status}): ${errorData.error?.message || 'Errore sconosciuto'}`);
        }
        
        const data = await res.json();
        return data.text;
    } catch (err) {
        throw err;
    }
}

/* ===== ASSEMBLYAI ===== */
async function transcribeWithAssemblyAI(blob, fileName) {
    const key = assemblyaiApiKey.value.trim();
    if (!key) {
        showStatus('‚ùå Inserisci la tua API Key AssemblyAI', 'error');
        return null;
    }
    
    localStorage.setItem('assemblyaiKey', key);
    
    try {
        // Step 1: Upload del file
        showStatus('üì§ Upload file in corso...', 'loading');
        
        const uploadRes = await fetch('https://api.assemblyai.com/v2/upload', {
            method: 'POST',
            headers: {
                'authorization': key,
            },
            body: blob
        });
        
        if (!uploadRes.ok) {
            const errorData = await uploadRes.json();
            throw new Error(`Errore upload AssemblyAI (${uploadRes.status}): ${errorData.error || 'Errore sconosciuto'}`);
        }
        
        const uploadData = await uploadRes.json();
        const audioUrl = uploadData.upload_url;
        
        // Step 2: Richiedi trascrizione
        showStatus('üéØ Trascrizione in corso...', 'loading');
        
        const transcriptRes = await fetch('https://api.assemblyai.com/v2/transcript', {
            method: 'POST',
            headers: {
                'authorization': key,
                'content-type': 'application/json',
            },
            body: JSON.stringify({
                audio_url: audioUrl,
                language_code: languageSelect.value,
            })
        });
        
        if (!transcriptRes.ok) {
            const errorData = await transcriptRes.json();
            throw new Error(`Errore trascrizione AssemblyAI (${transcriptRes.status}): ${errorData.error || 'Errore sconosciuto'}`);
        }
        
        const transcriptData = await transcriptRes.json();
        const transcriptId = transcriptData.id;
        
        // Step 3: Polling per il risultato
        let attempts = 0;
        const maxAttempts = 60; // 5 minuti max
        
        while (attempts < maxAttempts) {
            await new Promise(resolve => setTimeout(resolve, 5000)); // Attendi 5 secondi
            
            const statusRes = await fetch(`https://api.assemblyai.com/v2/transcript/${transcriptId}`, {
                headers: {
                    'authorization': key,
                }
            });
            
            if (!statusRes.ok) {
                throw new Error(`Errore verifica stato AssemblyAI (${statusRes.status})`);
            }
            
            const statusData = await statusRes.json();
            
            if (statusData.status === 'completed') {
                return statusData.text;
            } else if (statusData.status === 'error') {
                throw new Error(`Errore AssemblyAI: ${statusData.error}`);
            }
            
            // Aggiorna stato
            const progress = Math.min(95, Math.floor((attempts / maxAttempts) * 100));
            showStatus(`‚è≥ Trascrizione in corso... ${progress}%`, 'loading');
            
            attempts++;
        }
        
        throw new Error('Timeout: la trascrizione sta impiegando troppo tempo');
        
    } catch (err) {
        throw err;
    }
}

/* ===========================================
   INCOLLA TESTO
=========================================== */

usePastedTextBtn.addEventListener('click', () => {
    const text = pastedText.value.trim();
    if (!text) {
        showStatus('‚ö†Ô∏è Incolla del testo prima', 'error');
        return;
    }
    
    mainTranscript.textContent = text;
    localStorage.setItem('transcript', text);
    enableAnalysisButtons();
    showStatus('üìÑ Testo caricato!', 'success');
    
    setTimeout(() => {
        tabs.forEach(t => t.classList.remove('active'));
        tabContents.forEach(tc => tc.classList.remove('active'));
        document.querySelector('[data-tab="analysis"]').classList.add('active');
        document.getElementById('tab-analysis').classList.add('active');
    }, 800);
});

/* ===========================================
   FUNZIONI ANALISI AI (GROQ)
=========================================== */

function enableAnalysisButtons() {
    correctTextBtn.disabled = false;
    summarizeBtn.disabled = false;
    analyzeBtn.disabled = false;
    identifySpeakersBtn.disabled = false;
    exportPdfBtn.disabled = false;
    exportTxtBtn.disabled = false;
    analysisInfo.style.display = 'none';
}

async function callGroqAPI(prompt) {
    const key = groqApiKey.value.trim();
    if (!key) {
        showStatus('‚ùå Inserisci la tua API Key Groq', 'error');
        return null;
    }
    
    localStorage.setItem('groqKey', key);
    
    showStatus('ü§ñ Analisi AI in corso...', 'loading');
    
    try {
        const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${key}`,
            },
            body: JSON.stringify({
                model: 'llama-3.1-8b-instant',
                messages: [{ role: 'user', content: prompt }],
                temperature: 0.7,
                max_tokens: 4096,
            }),
        });
        
        if (!res.ok) {
            throw new Error(`Errore API: ${res.status}`);
        }
        
        const data = await res.json();
        return data.choices[0].message.content;
    } catch (err) {
        showStatus('‚ùå Errore Groq: ' + err.message, 'error');
        return null;
    }
}

/* ===== CORREZIONE TESTO ===== */
correctTextBtn.addEventListener('click', async () => {
    const text = mainTranscript.textContent.trim();
    if (!text) return;
    
    const prompt = `Correggi grammatica, punteggiatura e ortografia del seguente testo mantenendo il significato identico. Restituisci SOLO il testo corretto senza commenti:\n\n${text}`;
    
    const result = await callGroqAPI(prompt);
    if (!result) return;
    
    mainTranscript.textContent = result.trim();
    localStorage.setItem('transcript', result.trim());
    showStatus('‚ú® Testo corretto!', 'success');
});

/* ===== RIASSUNTO ===== */
summarizeBtn.addEventListener('click', async () => {
    const text = mainTranscript.textContent.trim();
    if (!text) return;
    
    const prompt = `Crea un riassunto strutturato del seguente testo in 5-7 punti chiave. Usa un formato chiaro con bullet points:\n\n${text}`;
    const result = await callGroqAPI(prompt);
    
    if (result) addAnalysisSection('üìù Riassunto', result);
});

/* ===== ANALISI COMPLETA ===== */
analyzeBtn.addEventListener('click', async () => {
    const text = mainTranscript.textContent.trim();
    if (!text) return;
    
    const prompt = `Analizza in modo approfondito il seguente testo. Includi:
1. Tema principale
2. Tono e stile
3. Punti chiave
4. Conclusioni o azioni da intraprendere

Testo:
${text}`;
    
    const result = await callGroqAPI(prompt);
    if (result) addAnalysisSection('üîç Analisi Completa', result);
});

/* ===== IDENTIFICAZIONE PARLANTI ===== */
identifySpeakersBtn.addEventListener('click', async () => {
    const text = mainTranscript.textContent.trim();
    if (!text) return;
    
    const prompt = `Analizza il seguente testo e identifica i possibili parlanti o interlocutori. Se sembrano esserci pi√π persone che parlano, suggerisci chi potrebbe dire cosa. Fornisci un'analisi chiara:\n\n${text}`;
    
    const result = await callGroqAPI(prompt);
    if (result) addAnalysisSection('üë• Identificazione Parlanti', result);
});

function addAnalysisSection(title, content) {
    const div = document.createElement('div');
    div.className = 'analysis-section';
    div.innerHTML = `<h3>${title}</h3><div class="analysis-content">${content.replace(/\n/g, '<br>')}</div>`;
    analysisResults.prepend(div);
    showStatus('‚ú® Analisi completata!', 'success');
}

/* ===========================================
   ESPORTAZIONE
=========================================== */

exportPdfBtn.addEventListener('click', () => {
    const text = mainTranscript.textContent.trim();
    if (!text) return;
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    const pageWidth = doc.internal.pageSize.getWidth();
    const margin = 15;
    const maxWidth = pageWidth - (margin * 2);
    
    doc.setFontSize(16);
    doc.text('Trascrizione Audio', margin, 20);
    
    doc.setFontSize(10);
    doc.text(`Data: ${new Date().toLocaleDateString('it-IT')}`, margin, 30);
    
    doc.setFontSize(12);
    const lines = doc.splitTextToSize(text, maxWidth);
    doc.text(lines, margin, 40);
    
    doc.save('trascrizione.pdf');
    showStatus('üìÑ PDF salvato!', 'success');
});

exportTxtBtn.addEventListener('click', () => {
    const text = mainTranscript.textContent.trim();
    if (!text) return;
    
    const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
    saveAs(blob, 'trascrizione.txt');
    showStatus('üìù TXT salvato!', 'success');
});

/* ===========================================
   GESTIONE SALVATI
=========================================== */

function saveToStorage(data) {
    let saved = JSON.parse(localStorage.getItem('savedRecordings') || '[]');
    saved.unshift(data);
    
    // Mantieni solo gli ultimi 50
    if (saved.length > 50) {
        saved = saved.slice(0, 50);
    }
    
    localStorage.setItem('savedRecordings', JSON.stringify(saved));
}

function loadSavedList() {
    const saved = JSON.parse(localStorage.getItem('savedRecordings') || '[]');
    
    if (saved.length === 0) {
        savedList.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 40px;">Nessuna registrazione salvata</p>';
return;
    }
    
    savedList.innerHTML = saved.map((item, index) => `
        <div class="saved-item">
            <div class="saved-item-header">
                <div class="saved-item-title">
                    ${item.type === 'recording' ? 'üéôÔ∏è' : item.type === 'upload' ? 'üìÅ' : 'üìã'} 
                    ${item.fileName || 'Registrazione'} #${item.id}
                </div>
                <div class="saved-item-date">${item.date}</div>
            </div>
            <div class="saved-item-text">${item.transcript.substring(0, 150)}...</div>
            <div class="saved-item-actions">
                <button class="btn btn-small btn-primary" onclick="loadSaved(${index})">
                    üìñ Carica
                </button>
                ${item.audioBlob ? `
                    <button class="btn btn-small btn-success" onclick="playAudio(${index})">
                        ‚ñ∂Ô∏è Ascolta
                    </button>
                ` : ''}
                <button class="btn btn-small btn-secondary" onclick="exportSavedTxt(${index})">
                    üìù TXT
                </button>
                <button class="btn btn-small btn-danger" onclick="deleteSaved(${index})">
                    üóëÔ∏è Elimina
                </button>
            </div>
        </div>
    `).join('');
}

function loadSaved(index) {
    const saved = JSON.parse(localStorage.getItem('savedRecordings') || '[]');
    const item = saved[index];
    
    if (item) {
        mainTranscript.textContent = item.transcript;
        localStorage.setItem('transcript', item.transcript);
        enableAnalysisButtons();
        
        // Passa alla tab analisi
        tabs.forEach(t => t.classList.remove('active'));
        tabContents.forEach(tc => tc.classList.remove('active'));
        document.querySelector('[data-tab="analysis"]').classList.add('active');
        document.getElementById('tab-analysis').classList.add('active');
        
        showStatus('üìñ Trascrizione caricata!', 'success');
    }
}

async function playAudio(index) {
    const saved = JSON.parse(localStorage.getItem('savedRecordings') || '[]');
    const item = saved[index];
    
    if (item && item.audioBlob) {
        const blob = await base64ToBlob(item.audioBlob);
        const url = URL.createObjectURL(blob);
        
        const audio = new Audio(url);
        audio.play();
        
        showStatus('‚ñ∂Ô∏è Riproduzione audio...', 'info');
    }
}

function exportSavedTxt(index) {
    const saved = JSON.parse(localStorage.getItem('savedRecordings') || '[]');
    const item = saved[index];
    
    if (item) {
        const blob = new Blob([item.transcript], { type: 'text/plain;charset=utf-8' });
        saveAs(blob, `trascrizione_${item.id}.txt`);
        showStatus('üìù TXT esportato!', 'success');
    }
}

function deleteSaved(index) {
    if (!confirm('Sei sicuro di voler eliminare questa registrazione?')) return;
    
    let saved = JSON.parse(localStorage.getItem('savedRecordings') || '[]');
    saved.splice(index, 1);
    localStorage.setItem('savedRecordings', JSON.stringify(saved));
    
    loadSavedList();
    showStatus('üóëÔ∏è Registrazione eliminata', 'info');
}

refreshSavedBtn.addEventListener('click', loadSavedList);

clearAllSavedBtn.addEventListener('click', () => {
    if (!confirm('‚ö†Ô∏è Sei sicuro di voler eliminare TUTTE le registrazioni salvate? Questa azione non pu√≤ essere annullata.')) {
        return;
    }
    
    localStorage.removeItem('savedRecordings');
    loadSavedList();
    showStatus('üóëÔ∏è Tutte le registrazioni eliminate', 'info');
});

/* ===========================================
   UTILITY FUNCTIONS
=========================================== */

async function blobToBase64(blob) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
    });
}

async function base64ToBlob(base64) {
    const response = await fetch(base64);
    return await response.blob();
}

/* ===========================================
   CANCELLA TUTTO
=========================================== */

clearBtn.addEventListener('click', () => {
    if (!confirm('‚ö†Ô∏è Sei sicuro di voler cancellare tutto? Questa azione non pu√≤ essere annullata.')) {
        return;
    }
    
    localStorage.clear();
    mainTranscript.textContent = 'Nessuna trascrizione disponibile.';
    liveTranscript.textContent = 'La trascrizione in tempo reale apparir√† qui...';
    liveTranscript.classList.add('empty');
    liveFileTranscript.style.display = 'none';
    pastedText.value = '';
    analysisResults.innerHTML = '';
    transcript = "";
    
    // Reset audio recordings
    recordedAudioSection.style.display = 'none';
    recordedBlob = null;
    recordedChunks = [];
    
    resumeBtn.style.display = 'none';
    
    correctTextBtn.disabled = true;
    summarizeBtn.disabled = true;
    analyzeBtn.disabled = true;
    identifySpeakersBtn.disabled = true;
    exportPdfBtn.disabled = true;
    exportTxtBtn.disabled = true;
    
    analysisInfo.style.display = 'block';
    
    loadSavedList();
    
    showStatus('üóëÔ∏è Tutto cancellato!', 'info');
});

/* ===========================================
   FUNZIONE STATUS
=========================================== */

function showStatus(msg, type) {
    statusDiv.className = 'status active ' + type;
    statusDiv.innerHTML = 
        type === 'loading' 
        ? `<div class="spinner"></div><span>${msg}</span>`
        : msg;
    
    if (type !== 'loading') {
        setTimeout(() => statusDiv.classList.remove('active'), 4000);
    }
}

/* ===========================================
   SALVATAGGIO AUTOMATICO
=========================================== */

groqApiKey.addEventListener('input', () => {
    localStorage.setItem('groqKey', groqApiKey.value);
    checkApiKeyNotices();
});

openaiApiKey.addEventListener('input', () => {
    localStorage.setItem('openaiKey', openaiApiKey.value);
    checkApiKeyNotices();
});

assemblyaiApiKey.addEventListener('input', () => {
    localStorage.setItem('assemblyaiKey', assemblyaiApiKey.value);
    checkApiKeyNotices();
});

languageSelect.addEventListener('change', () => {
    localStorage.setItem('language', languageSelect.value);
});

</script>

</body>
</html>
