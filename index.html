<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#667eea">
    <title>Trascrizione Audio Pro - Analisi Avanzata e Multi-Parlante</title>

    <!-- Librerie esterne -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wavesurfer.js/7.4.5/wavesurfer.min.js"></script>

    <style>
        /* RESET & BASE */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent; /* Rimuove highlight touch su iOS */
        }
        html {
            scroll-behavior: smooth; /* Scrolling fluido */
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            touch-action: manipulation; /* Migliora performance touch */
            overflow-x: hidden; /* Previene scroll orizzontale */
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: center;
            margin-bottom: 10px;
            font-size: 32px;
            font-weight: 700;
        }
        .subtitle {
            text-align: center;
            color: #6b7280;
            margin-bottom: 30px;
            font-size: 14px;
        }

        /* SPEAKER COLORS */
        .speaker-1 { 
            background: linear-gradient(90deg, #3b82f6, #2563eb);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
        }
        .speaker-2 { 
            background: linear-gradient(90deg, #10b981, #059669);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
        }
        .speaker-3 { 
            background: linear-gradient(90deg, #f59e0b, #d97706);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
        }
        .speaker-4 { 
            background: linear-gradient(90deg, #ef4444, #dc2626);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
        }
        .speaker-5 { 
            background: linear-gradient(90deg, #8b5cf6, #7c3aed);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
        }
        .speaker-unknown {
            background: linear-gradient(90deg, #6b7280, #4b5563);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
        }

        /* TRANSCRIPT SEGMENT */
        .transcript-segment {
            margin: 15px 0;
            padding: 15px;
            border-left: 4px solid;
            background: #f9fafb;
            border-radius: 8px;
            transition: all 0.3s;
        }
        .transcript-segment:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .transcript-segment.speaker-1-segment { border-left-color: #3b82f6; }
        .transcript-segment.speaker-2-segment { border-left-color: #10b981; }
        .transcript-segment.speaker-3-segment { border-left-color: #f59e0b; }
        .transcript-segment.speaker-4-segment { border-left-color: #ef4444; }
        .transcript-segment.speaker-5-segment { border-left-color: #8b5cf6; }

        .segment-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        .segment-timestamp {
            font-size: 12px;
            color: #6b7280;
        }
        .segment-text {
            line-height: 1.6;
            color: #1f2937;
        }
        .confidence-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 5px;
        }
        .confidence-high { background: #dcfce7; color: #166534; }
        .confidence-medium { background: #fef3c7; color: #92400e; }
        .confidence-low { background: #fee2e2; color: #991b1b; }

        /* TABS */
        .tabs { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 30px; 
            border-bottom: 2px solid #e5e7eb; 
            flex-wrap: wrap; 
        }
        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #6b7280;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .tab:hover {
            color: #667eea;
        }
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* RECORDING CONTROLS */
        .recording-controls {
            background: linear-gradient(135deg, #f9fafb, #f3f4f6);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
        }
        .control-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
            min-width: 200px;
        }
        .control-label {
            font-size: 13px;
            font-weight: 600;
            color: #4b5563;
            text-transform: uppercase;
        }

        /* WAVEFORM */
        #waveform {
            margin: 20px 0;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        /* STATS GRID */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, #f9fafb, #f3f4f6);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 13px;
            color: #6b7280;
            text-transform: uppercase;
        }

        /* SAVED SESSIONS */
        .sessions-list {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 15px;
        }
        .session-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: #f9fafb;
            border-radius: 8px;
            transition: all 0.3s;
        }
        .session-item:hover {
            background: #f3f4f6;
            transform: translateX(5px);
        }
        .session-info h4 {
            color: #1f2937;
            margin-bottom: 5px;
        }
        .session-meta {
            font-size: 12px;
            color: #6b7280;
        }
        .session-actions {
            display: flex;
            gap: 8px;
        }

        /* INFO BOX */
        .info-box {
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }
        .info-box.info { 
            background: #dbeafe; 
            border-left-color: #3b82f6;
            color: #1e40af;
        }
        .info-box.success {
            background: #dcfce7;
            border-left-color: #10b981;
            color: #166534;
        }
        .info-box.warning {
            background: #fef3c7;
            border-left-color: #f59e0b;
            color: #92400e;
        }

        /* UPLOAD AREA */
        .upload-area {
            border: 3px dashed #d1d5db;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        .upload-area:hover {
            border-color: #667eea;
            background: #f9fafb;
        }
        .upload-area.dragover {
            border-color: #667eea;
            background: linear-gradient(135deg, #eef2ff, #e0e7ff);
        }
        .upload-icon { 
            font-size: 48px; 
            margin-bottom: 10px;
            animation: bounce 2s infinite;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* BUTTONS */
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
            min-height: 44px; /* Touch target per mobile */
            -webkit-user-select: none;
            user-select: none;
        }
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.3);
            transition: left 0.5s;
        }
        .btn:hover::before {
            left: 100%;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102,126,234,0.4); }

        .btn-success { background: linear-gradient(135deg, #10b981, #059669); color: white; }
        .btn-warning { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
        .btn-secondary { background: linear-gradient(135deg, #6b7280, #4b5563); color: white; }
        .btn-danger { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
        .btn-info { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; }

        .btn.recording { 
            background: linear-gradient(135deg, #ef4444, #dc2626); 
            animation: pulse 1.5s infinite; 
        }
        @keyframes pulse {
            0%,100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(0.98); }
        }

        /* TRANSCRIPTION AREA */
        .transcript-area {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            min-height: 300px;
            max-height: 500px;
            overflow-y: auto;
            margin-bottom: 20px;
            font-size: 16px;
            line-height: 1.8;
            position: relative;
        }
        .transcript-area.empty {
            color: #9ca3af;
            font-style: italic;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .transcript-area::-webkit-scrollbar {
            width: 8px;
        }
        .transcript-area::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .transcript-area::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }

        /* LIVE INDICATOR */
        .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: #ef4444;
            color: white;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            animation: livePulse 2s infinite;
        }
        @keyframes livePulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        .live-dot {
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            animation: liveDot 1.5s infinite;
        }
        @keyframes liveDot {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.5); }
        }

        /* STATUS */
        .status {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
            display: none;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .status.active { display: flex; }
        .status.success { background: linear-gradient(135deg, #dcfce7, #bbf7d0); color: #166534; }
        .status.error { background: linear-gradient(135deg, #fee2e2, #fecaca); color: #991b1b; }
        .status.info { background: linear-gradient(135deg, #dbeafe, #bfdbfe); color: #1e40af; }
        .status.loading { background: linear-gradient(135deg, #fef3c7, #fde68a); color: #92400e; }

        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid currentColor;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ANALYSIS */
        .analysis-section {
            background: linear-gradient(135deg, #f9fafb, #f3f4f6);
            border-left: 4px solid #667eea;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .analysis-section h3 {
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 15px;
            font-size: 20px;
        }
        .analysis-content {
            line-height: 1.7;
            color: #374151;
        }
        .analysis-content ul,
        .analysis-content ol {
            margin-left: 20px;
            margin-top: 10px;
        }
        .analysis-content li {
            margin: 8px 0;
        }

        /* FORM ELEMENTS */
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }
        select, input[type="text"], input[type="password"], input[type="number"], textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 15px;
            margin-bottom: 15px;
            transition: all 0.3s;
            background: white;
        }
        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }
        textarea {
            min-height: 150px;
            resize: vertical;
            font-family: inherit;
        }
        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #667eea;
            margin-right: 8px;
        }
        input[type="range"] {
            accent-color: #667eea;
        }

        /* TOGGLE SWITCH */
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
        }
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            background: #e5e7eb;
            border-radius: 34px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .toggle-switch.active {
            background: #667eea;
        }
        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }
        .toggle-switch.active .toggle-slider {
            transform: translateX(24px);
        }

        /* AUDIO VISUALIZER */
        .audio-visualizer {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 60px;
            gap: 3px;
            margin: 20px 0;
        }
.visualizer-bar {
            width: 4px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 2px;
            animation: audioWave 1s ease-in-out infinite;
        }
        .visualizer-bar:nth-child(odd) {
            animation-delay: 0.1s;
        }
        .visualizer-bar:nth-child(even) {
            animation-delay: 0.2s;
        }
        @keyframes audioWave {
            0%, 100% { height: 10px; }
            50% { height: 40px; }
        }

        /* RESPONSIVE - MOBILE FIRST */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 15px;
                border-radius: 15px;
            }
            
            h1 {
                font-size: 24px;
                margin-bottom: 8px;
            }
            
            .subtitle {
                font-size: 12px;
                margin-bottom: 20px;
            }
            
            /* Tabs mobile */
            .tabs {
                gap: 5px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                padding-bottom: 5px;
            }
            .tabs::-webkit-scrollbar {
                display: none;
            }
            .tab {
                padding: 8px 12px;
                font-size: 13px;
                white-space: nowrap;
                flex-shrink: 0;
            }
            
            /* Buttons mobile */
            .button-group {
                flex-direction: column;
                gap: 10px;
            }
            .btn {
                width: 100%;
                padding: 12px 20px;
                font-size: 14px;
            }
            
            /* Stats grid mobile */
            .stats-grid {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }
            .stat-box {
                padding: 12px;
            }
            .stat-value {
                font-size: 20px;
            }
            .stat-label {
                font-size: 11px;
            }
            
            /* Controls mobile */
            .control-row {
                flex-direction: column;
                gap: 15px;
            }
            .control-group {
                width: 100%;
            }
            .control-label {
                font-size: 12px;
            }
            select, input[type="text"], input[type="password"], input[type="number"], textarea {
                font-size: 16px; /* Previene zoom su iOS */
                padding: 10px;
            }
            
            /* Transcript mobile */
            .transcript-area {
                height: 250px;
                font-size: 14px;
                padding: 12px;
            }
            
            /* Segments mobile */
            .transcript-segment {
                padding: 12px;
                margin-bottom: 10px;
            }
            .segment-header {
                flex-wrap: wrap;
                gap: 6px;
                font-size: 12px;
            }
            .segment-text {
                font-size: 14px;
                line-height: 1.5;
            }
            
            /* Info boxes mobile */
            .info-box {
                padding: 12px;
                font-size: 13px;
            }
            
            /* Recording controls mobile */
            .recording-controls {
                padding: 15px;
            }
            
            /* Toggle switches mobile */
            .toggle-switch {
                width: 44px;
                height: 24px;
            }
            .toggle-slider {
                width: 18px;
                height: 18px;
            }
            .toggle-switch.active .toggle-slider {
                transform: translateX(20px);
            }
            
            /* Audio visualizer mobile */
            .audio-visualizer {
                height: 60px;
            }
            .visualizer-bar {
                width: 3px;
            }
            
            /* History cards mobile */
            .history-card {
                padding: 12px;
            }
            .history-info {
                font-size: 12px;
            }
            
            /* Drop zone mobile */
            .drop-zone {
                padding: 30px 15px;
                font-size: 14px;
            }
            
            /* Analysis results mobile */
            .analysis-card {
                padding: 15px;
            }
            
            /* Tooltip mobile */
            .tooltip .tooltiptext {
                width: 150px;
                margin-left: -75px;
                font-size: 11px;
            }
            
            /* Status mobile */
            .status {
                font-size: 13px;
                padding: 10px 15px;
            }
        }
        
        /* MOBILE SMALL (< 480px) */
        @media (max-width: 480px) {
            body {
                padding: 5px;
            }
            
            .container {
                padding: 10px;
                border-radius: 10px;
            }
            
            h1 {
                font-size: 20px;
            }
            
            .subtitle {
                font-size: 11px;
            }
            
            .tab {
                padding: 6px 10px;
                font-size: 12px;
            }
            
            .btn {
                padding: 10px 15px;
                font-size: 13px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .transcript-area {
                height: 200px;
                font-size: 13px;
            }
        }
        
        /* LANDSCAPE MOBILE */
        @media (max-height: 500px) and (orientation: landscape) {
            .transcript-area {
                height: 150px;
            }
            
            .audio-visualizer {
                height: 40px;
            }
            
            .info-box {
                padding: 8px;
                font-size: 12px;
            }
        }

        /* PROGRESS BAR */
        .progress-container {
            margin: 20px 0;
        }
        .progress-bar {
            height: 8px;
            background: #e5e7eb;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 10px;
            transition: width 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: progressShine 2s linear infinite;
        }
        @keyframes progressShine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 12px;
            color: #6b7280;
        }

        /* TOOLTIP */
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background: #1f2937;
            color: white;
            text-align: center;
            border-radius: 8px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéôÔ∏è Trascrizione Audio Pro</h1>
        <div class="subtitle">Sistema avanzato di trascrizione con identificazione parlanti e analisi AI</div>
        
        <!-- Status -->
        <div id="status" class="status"></div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" data-tab="live">üé§ Registrazione Live</button>
            <button class="tab" data-tab="file">üìÅ Carica File</button>
            <button class="tab" data-tab="paste">üìù Incolla Testo</button>
            <button class="tab" data-tab="analysis">üîç Analisi & Risultati</button>
            <button class="tab" data-tab="history">üíæ Sessioni Salvate</button>
            <button class="tab" data-tab="settings">‚öôÔ∏è Impostazioni</button>
        </div>

        <!-- Tab: Live Recording -->
        <div id="tab-live" class="tab-content active">
            <div class="info-box info">
                <div>
                    <strong>üìå Registrazione Avanzata Multi-Parlante</strong><br>
                    ‚Ä¢ Identificazione automatica dei parlanti<br>
                    ‚Ä¢ Visualizzazione in tempo reale con colori distintivi<br>
                    ‚Ä¢ Salvataggio automatico audio e trascrizione<br>
                    ‚Ä¢ Analisi della confidenza per ogni segmento
                </div>
            </div>
            <div class="info-box warning" style="margin-top: 10px;">
                <div>
                    <strong>üí° Suggerimenti per una migliore trascrizione:</strong><br>
                    ‚Ä¢ Parla chiaramente e a volume normale<br>
                    ‚Ä¢ Riduci rumori di fondo (chiudi finestre, silenzia notifiche)<br>
                    ‚Ä¢ Usa un microfono di buona qualit√† se disponibile<br>
                    ‚Ä¢ Verifica che il browser abbia i permessi per il microfono<br>
                    ‚Ä¢ Apri la console (F12) per vedere i log di debug se la trascrizione non funziona
                </div>
            </div>
            <div class="info-box success" style="margin-top: 10px; display:none;" id="wakeLockInfo">
                <div>
                    <strong>üîã Modalit√† Schermo Attivo</strong><br>
                    Il dispositivo manterr√† lo schermo attivo durante la registrazione per garantire che la trascrizione continui senza interruzioni, anche con schermo spento o in background.
                </div>
            </div>

            <div class="recording-controls">
                <div class="control-row">
                    <div class="control-group">
                        <span class="control-label">Lingua</span>
                        <select id="languageSelect">
                            <option value="it-IT">üáÆüáπ Italiano</option>
                            <option value="en-US">üá∫üá∏ English (US)</option>
                            <option value="en-GB">üá¨üáß English (UK)</option>
                            <option value="es-ES">üá™üá∏ Espa√±ol</option>
                            <option value="fr-FR">üá´üá∑ Fran√ßais</option>
                            <option value="de-DE">üá©üá™ Deutsch</option>
                            <option value="pt-PT">üáµüáπ Portugu√™s</option>
                            <option value="zh-CN">üá®üá≥ ‰∏≠Êñá</option>
                            <option value="ja-JP">üáØüáµ Êó•Êú¨Ë™û</option>
                            <option value="ru-RU">üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
                            <option value="ar-SA">üá∏üá¶ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <span class="control-label">Modalit√†</span>
                        <div class="toggle-container">
                            <span>Continua</span>
                            <div id="continuousToggle" class="toggle-switch active">
                                <div class="toggle-slider"></div>
                            </div>
                            <span>Interrotta</span>
                        </div>
                    </div>
                    <div class="control-group">
                        <span class="control-label">Rilevamento Parlanti</span>
                        <div class="toggle-container">
                            <span>Off</span>
                            <div id="speakerDetectionToggle" class="toggle-switch active">
                                <div class="toggle-slider"></div>
                            </div>
                            <span>On</span>
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button id="startBtn" class="btn btn-primary">
                        <span>üé§</span> Avvia Registrazione
                    </button>
                    <button id="stopBtn" class="btn btn-danger" disabled>
                        <span>‚èπÔ∏è</span> Ferma
                    </button>
                    <button id="pauseBtn" class="btn btn-warning" disabled>
                        <span>‚è∏Ô∏è</span> Pausa
                    </button>
                    <button id="resumeBtn" class="btn btn-success" style="display:none;">
                        <span>‚ñ∂Ô∏è</span> Riprendi
                    </button>
                    <button id="saveSessionBtn" class="btn btn-info" disabled>
                        <span>üíæ</span> Salva Sessione
                    </button>
                </div>
            </div>

            <!-- Live Stats -->
            <div class="stats-grid" id="liveStats" style="display:none;">
                <div class="stat-card">
                    <div class="stat-value" id="wordCount">0</div>
                    <div class="stat-label">Parole</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="speakerCount">0</div>
                    <div class="stat-label">Parlanti</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="duration">00:00</div>
                    <div class="stat-label">Durata</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="confidenceAvg">-</div>
                    <div class="stat-label">Confidenza Media</div>
                </div>
            </div>

            <!-- Audio Visualizer -->
            <div class="audio-visualizer" id="visualizer" style="display:none;">
                <div class="visualizer-bar"></div>
                <div class="visualizer-bar"></div>
                <div class="visualizer-bar"></div>
                <div class="visualizer-bar"></div>
                <div class="visualizer-bar"></div>
                <div class="visualizer-bar"></div>
                <div class="visualizer-bar"></div>
                <div class="visualizer-bar"></div>
                <div class="visualizer-bar"></div>
                <div class="visualizer-bar"></div>
            </div>

            <!-- Live Transcript -->
            <div id="liveTranscript" class="transcript-area empty">
                La trascrizione in tempo reale apparir√† qui...
            </div>

            <!-- Recorded Audio -->
            <div id="recordedAudioSection" style="display:none;">
                <h3>üéµ Audio Registrato</h3>
                <div id="waveform"></div>
                <audio id="recordedAudio" controls style="width:100%; margin-top:10px;"></audio>
            </div>
        </div>

        <!-- Tab: File Upload -->
        <div id="tab-file" class="tab-content">
            <div class="info-box warning" style="margin-bottom: 20px;">
                <strong>üîë API Key Richiesta</strong><br>
                Per trascrivere file audio, inserisci la tua API Key Groq nella sezione Impostazioni. La trascrizione usa Groq Whisper Large V3.
            </div>
            
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üì§</div>
                <h3>Trascina un file audio qui</h3>
                <p style="color:#6b7280; margin:10px 0;">oppure clicca per selezionare</p>
                <p style="font-size:12px; color:#9ca3af;">Formati: MP3, WAV, M4A, OGG, WebM (max 100MB)</p>
                <input type="file" id="audioFile" accept="audio/*" hidden>
            </div>

            <div class="progress-container" id="uploadProgress" style="display:none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width:0%"></div>
                </div>
                <div class="progress-label">
                    <span>Elaborazione...</span>
                    <span id="progressPercent">0%</span>
                </div>
            </div>

            <div id="fileTranscriptArea" style="display:none;">
                <h3>üìÑ Trascrizione del File</h3>
                
                <div id="fileTranscript" class="transcript-area empty">
                    La trascrizione apparir√† qui...
                </div>
                
                <!-- Controlli per trascrizione in tempo reale -->
                <div style="margin-top: 20px; padding: 15px; background: #f9fafb; border-radius: 10px;">
                    <div class="info-box info" style="margin-bottom: 15px;">
                        <strong>üéôÔ∏è Trascrizione Live Aggiuntiva</strong><br>
                        Vuoi aggiungere pi√π contenuto? Riproduci il file audio (o parlane) e clicca "Avvia Trascrizione Live" per continuare a trascrivere tramite microfono.
                    </div>
                    
                    <div class="button-group">
                        <button id="startLiveTranscriptionBtn" class="btn btn-primary">
                            <span>üé§</span> Avvia Trascrizione Live
                        </button>
                        <button id="stopLiveTranscriptionBtn" class="btn btn-danger" disabled style="display:none;">
                            <span>‚èπÔ∏è</span> Ferma Trascrizione
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Paste Text -->
        <div id="tab-paste" class="tab-content">
            <div class="info-box warning">
                <strong>üìã Incolla o scrivi il testo da analizzare</strong><br>
                Puoi incollare trascrizioni esistenti per applicare l'identificazione dei parlanti e le analisi AI.
            </div>
            
            <textarea id="pastedText" placeholder="Incolla qui il tuo testo..."></textarea>
            
            <div class="button-group">
                <button id="analyzeTextBtn" class="btn btn-primary">
                    <span>üîç</span> Analizza Testo
                </button>
                <button id="identifySpeakersTextBtn" class="btn btn-info">
                    <span>üë•</span> Identifica Parlanti
                </button>
                <button id="clearTextBtn" class="btn btn-secondary">
                    <span>üóëÔ∏è</span> Pulisci
                </button>
            </div>
        </div>

        <!-- Tab: Analysis -->
        <div id="tab-analysis" class="tab-content">
            <div class="info-box info" id="analysisInfo">
                <strong>‚ÑπÔ∏è Area Analisi</strong><br>
                Registra o carica un audio per abilitare le funzioni di analisi avanzate.
            </div>

            <!-- Main Transcript Display -->
            <div style="display:none;" id="transcriptSection">
                <h3>üìù Trascrizione Completa</h3>
                <div id="mainTranscript" class="transcript-area">
                    Nessuna trascrizione disponibile.
                </div>
            </div>

            <!-- Analysis Tools -->
                    <div class="button-group" style="margin-top:20px;">
                <button id="correctTextBtn" class="btn btn-primary" disabled>
                    <span>‚ú®</span> Correggi Testo
                </button>
                <button id="summarizeBtn" class="btn btn-info" disabled>
                    <span>üìù</span> Riassumi
                </button>
                <button id="analyzeBtn" class="btn btn-warning" disabled>
                    <span>üîç</span> Analisi Completa
                </button>
                <button id="sentimentBtn" class="btn btn-success" disabled>
                    <span>üòä</span> Analisi Sentiment
                </button>
                <button id="keywordsBtn" class="btn btn-primary" disabled>
                    <span>üè∑Ô∏è</span> Estrai Keywords
                </button>
                <button id="actionItemsBtn" class="btn btn-danger" disabled>
                    <span>‚úÖ</span> Action Items
                </button>
            </div>

            <!-- Export Options -->
            <div class="button-group">
                <button id="exportPdfBtn" class="btn btn-secondary" disabled>
                    <span>üìÑ</span> Esporta PDF
                </button>
                <button id="exportTxtBtn" class="btn btn-secondary" disabled>
                    <span>üìù</span> Esporta TXT
                </button>
                <button id="exportJsonBtn" class="btn btn-secondary" disabled>
                    <span>üíæ</span> Esporta JSON
                </button>
                <button id="exportDocxBtn" class="btn btn-secondary" disabled>
                    <span>üìò</span> Esporta DOCX
                </button>
            </div>

            <!-- API Key Input -->
            <div style="margin-top:30px;">
                <label for="groqApiKey">üîë Groq API Key (per analisi AI)</label>
                <input type="password" id="groqApiKey" placeholder="gsk_...">
                <small style="color:#6b7280;">
                    Ottieni la tua chiave gratuita su 
                    <a href="https://console.groq.com" target="_blank" style="color:#667eea;">console.groq.com</a>
                </small>
            </div>

            <!-- Analysis Results -->
            <div id="analysisResults" style="margin-top:30px;"></div>
        </div>

        <!-- Tab: History -->
        <div id="tab-history" class="tab-content">
            <div class="info-box info">
                <strong>üíæ Sessioni Salvate</strong><br>
                Tutte le tue registrazioni e trascrizioni sono salvate localmente nel browser.
            </div>

            <div class="button-group">
                <button id="refreshHistoryBtn" class="btn btn-primary">
                    <span>üîÑ</span> Aggiorna Lista
                </button>
                <button id="clearHistoryBtn" class="btn btn-danger">
                    <span>üóëÔ∏è</span> Cancella Tutto
                </button>
                <button id="exportAllBtn" class="btn btn-info">
                    <span>üì¶</span> Esporta Tutto
                </button>
            </div>

            <div id="sessionsList" class="sessions-list">
                <p style="text-align:center; color:#9ca3af;">Nessuna sessione salvata</p>
            </div>
        </div>

        <!-- Tab: Settings -->
        <div id="tab-settings" class="tab-content">
            <h3>‚öôÔ∏è Impostazioni Avanzate</h3>
            
            <div style="margin-bottom:30px;">
                <h4>üé§ Impostazioni Riconoscimento Vocale</h4>
                
                <label>Confidenza Minima (%)</label>
                <input type="range" id="confidenceThreshold" min="0" max="100" value="70">
                <span id="confidenceValue">70%</span>
                
                <label>Numero Massimo Parlanti</label>
                <input type="number" id="maxSpeakers" min="2" max="10" value="5">
                
                <label>Pausa Minima tra Parlanti (ms)</label>
                <input type="number" id="speakerPause" min="500" max="5000" value="1500" step="100">
                
                <div class="toggle-container" style="margin-top:15px;">
                    <span>Punteggiatura Automatica</span>
                    <div id="autoPunctuationToggle" class="toggle-switch active">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
                
                <div class="toggle-container">
                    <span>Filtro Rumore</span>
                    <div id="noiseFilterToggle" class="toggle-switch active">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
            </div>

            <div style="margin-bottom:30px;">
                <h4>üíæ Impostazioni Salvataggio</h4>
                
                <div class="toggle-container">
                    <span>Salvataggio Automatico</span>
                    <div id="autoSaveToggle" class="toggle-switch active">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
                
                <label>Intervallo Salvataggio (secondi)</label>
                <input type="number" id="autoSaveInterval" min="10" max="300" value="30">
                
                <div class="toggle-container">
                    <span>Salva Audio Originale</span>
                    <div id="saveAudioToggle" class="toggle-switch active">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
            </div>

            <div>
                <h4>üé® Personalizzazione Colori Parlanti</h4>
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:10px;">
                    <div>
                        <label>Parlante 1</label>
                        <input type="color" id="speaker1Color" value="#3b82f6">
                    </div>
                    <div>
                        <label>Parlante 2</label>
                        <input type="color" id="speaker2Color" value="#10b981">
                    </div>
                    <div>
                        <label>Parlante 3</label>
                        <input type="color" id="speaker3Color" value="#f59e0b">
                    </div>
                    <div>
                        <label>Parlante 4</label>
                        <input type="color" id="speaker4Color" value="#ef4444">
                    </div>
                    <div>
                        <label>Parlante 5</label>
                        <input type="color" id="speaker5Color" value="#8b5cf6">
                    </div>
                </div>
            </div>

            <button id="saveSettingsBtn" class="btn btn-success" style="margin-top:20px;">
                <span>üíæ</span> Salva Impostazioni
            </button>
        </div>
    </div>

    <script>
    // ============================================
    // INIZIALIZZAZIONE E VARIABILI GLOBALI
    // ============================================
    
    let recognition = null;
    let liveFileRecognition = null; // Riconoscimento per file audio
    let mediaRecorder = null;
    let recordedChunks = [];
    let recordedBlob = null;
    let isRecording = false;
    let isPaused = false;
    let isLiveTranscribing = false; // Flag per trascrizione live del file
    let transcript = "";
    let speakers = new Map();
    let currentSpeaker = 1;
    let lastSpeechTime = Date.now();
    let sessionStartTime = null;
    let autoSaveInterval = null;
    let wavesurfer = null;
    let sessions = [];
    let currentSessionId = null;
    let speakerColors = {};
    let interimTranscript = '';
    let finalTranscript = '';
    let wakeLock = null; // Wake Lock per mantenere schermo attivo
    
    // Configurazione
    const config = {
        confidenceThreshold: 0.1,
        maxSpeakers: 5,
        speakerPauseThreshold: 1500,
        autoPunctuation: true,
        noiseFilter: true,
        autoSave: true,
        autoSaveIntervalSec: 30,
        saveAudio: true,
        continuousMode: true,
        speakerDetection: true
    };
    
    // Database IndexedDB per salvare sessioni
    let db;
    const DB_NAME = 'TranscriptionDB';
    const DB_VERSION = 1;
    
    // ============================================
    // ELEMENTI DOM
    // ============================================
    
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    const statusDiv = document.getElementById('status');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const resumeBtn = document.getElementById('resumeBtn');
    const saveSessionBtn = document.getElementById('saveSessionBtn');
    const liveTranscript = document.getElementById('liveTranscript');
    const mainTranscript = document.getElementById('mainTranscript');
    const languageSelect = document.getElementById('languageSelect');
    const groqApiKey = document.getElementById('groqApiKey');
    const uploadArea = document.getElementById('uploadArea');
    const audioFile = document.getElementById('audioFile');
    const pastedText = document.getElementById('pastedText');
    const analysisResults = document.getElementById('analysisResults');
    const sessionsList = document.getElementById('sessionsList');
    const visualizer = document.getElementById('visualizer');
    const liveStats = document.getElementById('liveStats');
    const recordedAudioSection = document.getElementById('recordedAudioSection');
    const recordedAudio = document.getElementById('recordedAudio');
    
    // Bottoni analisi
    const correctTextBtn = document.getElementById('correctTextBtn');
    const summarizeBtn = document.getElementById('summarizeBtn');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const sentimentBtn = document.getElementById('sentimentBtn');
    const keywordsBtn = document.getElementById('keywordsBtn');
    const actionItemsBtn = document.getElementById('actionItemsBtn');
    
    // Bottoni export
    const exportPdfBtn = document.getElementById('exportPdfBtn');
    const exportTxtBtn = document.getElementById('exportTxtBtn');
    const exportJsonBtn = document.getElementById('exportJsonBtn');
    const exportDocxBtn = document.getElementById('exportDocxBtn');
    
    // Toggle switches
    const continuousToggle = document.getElementById('continuousToggle');
    const speakerDetectionToggle = document.getElementById('speakerDetectionToggle');
    const autoPunctuationToggle = document.getElementById('autoPunctuationToggle');
    const noiseFilterToggle = document.getElementById('noiseFilterToggle');
    const autoSaveToggle = document.getElementById('autoSaveToggle');
    const saveAudioToggle = document.getElementById('saveAudioToggle');
    
    // Pulsanti trascrizione live file audio
    const startLiveTranscriptionBtn = document.getElementById('startLiveTranscriptionBtn');
    const stopLiveTranscriptionBtn = document.getElementById('stopLiveTranscriptionBtn');
    
    // ============================================
    // WAKE LOCK - Mantieni schermo attivo durante registrazione
    // ============================================
    
    async function requestWakeLock() {
        if (!('wakeLock' in navigator)) {
            console.log('Wake Lock API non supportata su questo browser');
            return false;
        }
        
        try {
            wakeLock = await navigator.wakeLock.request('screen');
            console.log('‚úÖ Wake Lock attivato - Lo schermo rimarr√† attivo durante la registrazione');
            
            // Mostra info box
            const wakeLockInfo = document.getElementById('wakeLockInfo');
            if (wakeLockInfo) {
                wakeLockInfo.style.display = 'block';
            }
            
            wakeLock.addEventListener('release', function() {
                console.log('Wake Lock rilasciato');
                if (wakeLockInfo) {
                    wakeLockInfo.style.display = 'none';
                }
            });
            
            // Riattiva Wake Lock se la pagina torna visibile
            document.addEventListener('visibilitychange', async function() {
                if (wakeLock !== null && document.visibilityState === 'visible' && isRecording) {
                    try {
                        wakeLock = await navigator.wakeLock.request('screen');
                        console.log('Wake Lock riattivato dopo visibilit√†');
                    } catch (err) {
                        console.error('Errore riattivazione Wake Lock:', err);
                    }
                }
            });
            
            return true;
        } catch (err) {
            console.error('Errore richiesta Wake Lock:', err.name, err.message);
            return false;
        }
    }
    
    function releaseWakeLock() {
        if (wakeLock !== null) {
            wakeLock.release()
                .then(function() {
                    wakeLock = null;
                    console.log('Wake Lock rilasciato manualmente');
                })
                .catch(function(err) {
                    console.error('Errore rilascio Wake Lock:', err);
                });
        }
    }
    
    // ============================================
    // INIZIALIZZAZIONE DATABASE
    // ============================================
    function initDB() {
        return new Promise(function(resolve, reject) {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            
            request.onerror = function() {
                console.error('Errore apertura database:', request.error);
                reject(request.error);
            };
            
            request.onsuccess = function() {
                db = request.result;
                console.log('Database aperto con successo');
                resolve(db);
            };
            
            request.onupgradeneeded = function(event) {
                db = event.target.result;
                console.log('Upgrade database necessario');
                
                if (!db.objectStoreNames.contains('sessions')) {
                    const sessionStore = db.createObjectStore('sessions', { keyPath: 'id' });
                    sessionStore.createIndex('date', 'date', { unique: false });
                    console.log('Created sessions store');
                }
                
                if (!db.objectStoreNames.contains('audio')) {
                    const audioStore = db.createObjectStore('audio', { keyPath: 'sessionId' });
                    console.log('Created audio store');
                }
            };
        });
    }
    
    // ============================================
    // GESTIONE TABS
    // ============================================
    
    tabs.forEach(function(tab) {
        tab.addEventListener('click', function() {
            const targetTab = tab.dataset.tab;
            
            tabs.forEach(function(t) { t.classList.remove('active'); });
            tabContents.forEach(function(tc) { tc.classList.remove('active'); });
            
            tab.classList.add('active');
            document.getElementById('tab-' + targetTab).classList.add('active');
            
            if (targetTab === 'history') {
                loadSessions();
            }
        });
    });
    
    // ============================================
    // SPEAKER DETECTION E COLORAZIONE
    // ============================================
    
    function detectSpeakerChange(text, confidence) {
        if (!config.speakerDetection) {
            return 1;
        }
        
        const now = Date.now();
        const timeSinceLastSpeech = now - lastSpeechTime;
        
        // Se c'√® stata una pausa significativa, potrebbe essere un nuovo parlante
        if (timeSinceLastSpeech > config.speakerPauseThreshold) {
            // Analisi semplice basata su pattern di parlato
            const patterns = analyzeTextPattern(text);
            
            // Se il pattern √® molto diverso, assegna un nuovo parlante
            if (patterns.isDifferent) {
                currentSpeaker = (currentSpeaker % config.maxSpeakers) + 1;
            }
        }
        
        lastSpeechTime = now;
        return currentSpeaker;
    }
    
    function analyzeTextPattern(text) {
        // Analisi basica del pattern di parlato
        const questions = (text.match(/\?/g) || []).length;
        const exclamations = (text.match(/!/g) || []).length;
        const avgWordLength = text.split(' ').reduce(function(acc, word) { return acc + word.length; }, 0) / text.split(' ').length;
        
        // Confronta con pattern precedenti (semplificato)
        const isDifferent = Math.random() > 0.7; // Simulazione per demo
        
        return { questions, exclamations, avgWordLength, isDifferent };
    }
    
    function createSpeakerSegment(text, speakerId, confidence) {
        if (typeof confidence === 'undefined') confidence = 1;
        
        const segment = document.createElement('div');
        segment.className = 'transcript-segment speaker-' + speakerId + '-segment';
        
        const header = document.createElement('div');
        header.className = 'segment-header';
        
        const speakerLabel = document.createElement('span');
        speakerLabel.className = 'speaker-' + speakerId;
        speakerLabel.textContent = 'Parlante ' + speakerId;
        
        const timestamp = document.createElement('span');
        timestamp.className = 'segment-timestamp';
        timestamp.textContent = new Date().toLocaleTimeString('it-IT');
        
        const confidenceBadge = document.createElement('span');
        confidenceBadge.className = 'confidence-badge ' + getConfidenceClass(confidence);
        confidenceBadge.textContent = Math.round(confidence * 100) + '%';
        
        header.appendChild(speakerLabel);
        header.appendChild(timestamp);
        header.appendChild(confidenceBadge);
        
        const textDiv = document.createElement('div');
        textDiv.className = 'segment-text';
        textDiv.textContent = text;
        
        segment.appendChild(header);
        segment.appendChild(textDiv);
        
        return segment;
    }
    
    function getConfidenceClass(confidence) {
        if (confidence >= 0.8) return 'confidence-high';
        if (confidence >= 0.5) return 'confidence-medium';
        return 'confidence-low';
    }
    
    // ============================================
    // RICONOSCIMENTO VOCALE AVANZATO
    // ============================================
    
    function initSpeechRecognition() {
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
            showStatus('‚ùå Il tuo browser non supporta il riconoscimento vocale', 'error');
            return false;
        }
        
        const SpeechRecognition = window.webkitSpeechRecognition || window.SpeechRecognition;
        recognition = new SpeechRecognition();
        
        // Configurazione ottimizzata per migliore riconoscimento
        recognition.continuous = config.continuousMode;
        recognition.interimResults = true;
        recognition.maxAlternatives = 5;  // Aumentato per migliori alternative
        recognition.lang = languageSelect.value;
        
        recognition.onstart = function() {
            console.log('üé§ Riconoscimento vocale avviato - Lingua:', recognition.lang);
            const wakeLockStatus = wakeLock ? ' üîã Schermo attivo' : '';
            showStatus('üé§ Registrazione in corso... Inizia a parlare!' + wakeLockStatus, 'loading');
            visualizer.style.display = 'flex';
            liveStats.style.display = 'grid';
            liveTranscript.classList.remove('empty');
            if (liveTranscript.textContent === 'La trascrizione in tempo reale apparir√† qui...') {
                liveTranscript.innerHTML = '';
            }
            sessionStartTime = Date.now();
            updateStats();
            
            if (config.autoSave) {
                autoSaveInterval = setInterval(function() {
                    saveCurrentSession(true);
                }, config.autoSaveIntervalSec * 1000);
            }
        };
        
        recognition.onresult = function(event) {
            let interimText = '';
            
            for (let i = event.resultIndex; i < event.results.length; i++) {
                const result = event.results[i];
                
                // Scegli l'alternativa con la confidenza pi√π alta
                let bestTranscript = result[0].transcript;
                let bestConfidence = result[0].confidence || 0.5;
                
                // Controlla alternative se disponibili
                for (let j = 1; j < result.length && j < 3; j++) {
                    const altConfidence = result[j].confidence || 0;
                    if (altConfidence > bestConfidence) {
                        bestTranscript = result[j].transcript;
                        bestConfidence = altConfidence;
                    }
                }
                
                const transcriptText = bestTranscript.trim();
                const confidence = bestConfidence;
                
                if (result.isFinal) {
                    console.log('‚úÖ Testo riconosciuto:', transcriptText, '| Confidenza:', (confidence * 100).toFixed(0) + '%');
                    
                    // Rimuovi il testo interim se presente
                    const interimDiv = document.getElementById('interimText');
                    if (interimDiv) {
                        interimDiv.remove();
                    }
                    
                    // Rileva cambio parlante
                    const speakerId = detectSpeakerChange(transcriptText, confidence);
                    
                    // Aggiungi al transcript con identificazione parlante
                    const segment = createSpeakerSegment(transcriptText, speakerId, confidence);
                    liveTranscript.appendChild(segment);
                    
                    // Aggiorna transcript globale
                    transcript += '[Parlante ' + speakerId + ']: ' + transcriptText + '\n';
                    
                    // Aggiorna statistiche parlanti
                    if (!speakers.has(speakerId)) {
                        speakers.set(speakerId, {
                            words: 0,
                            segments: 0,
                            totalConfidence: 0
                        });
                    }
                    
                    const speakerData = speakers.get(speakerId);
                    speakerData.words += transcriptText.split(' ').length;
                    speakerData.segments++;
                    speakerData.totalConfidence += confidence;
                    
                    updateStats();
                    
                    // Auto scroll
                    liveTranscript.scrollTop = liveTranscript.scrollHeight;
                    
                } else {
                    interimText += transcriptText;
                }
            }
            
            // Mostra risultati interim
            if (interimText) {
                console.log('üîÑ Testo temporaneo:', interimText);
                let tempDiv = document.getElementById('interimText');
                if (!tempDiv) {
                    tempDiv = document.createElement('div');
                    tempDiv.id = 'interimText';
                    tempDiv.style.opacity = '0.7';
                    tempDiv.style.fontStyle = 'italic';
                    tempDiv.style.color = '#667eea';
                    liveTranscript.appendChild(tempDiv);
                }
                tempDiv.textContent = 'üé§ ' + interimText;
                // Auto scroll anche per interim
                liveTranscript.scrollTop = liveTranscript.scrollHeight;
            }
        };
        
        recognition.onerror = function(event) {
            console.error('Speech recognition error:', event.error);
            
            if (event.error === 'no-speech') {
                // Non mostrare notifiche continue per no-speech in modalit√† continua
                // √à normale non parlare per alcuni secondi
                if (!config.continuousMode) {
                    showStatus('üîá Nessun audio rilevato', 'warning');
                }
                // L'evento onend gestir√† il riavvio automatico
            } else if (event.error === 'audio-capture') {
                showStatus('‚ùå Errore microfono', 'error');
                isRecording = false;
            } else if (event.error === 'not-allowed') {
                showStatus('‚ùå Permesso microfono negato', 'error');
                isRecording = false;
            } else if (event.error === 'aborted') {
                // Errore normale quando si stoppa manualmente
                console.log('Recognition aborted');
            } else {
                showStatus('‚ùå Errore: ' + event.error, 'error');
            }
        };
        
        recognition.onend = function() {
            if (isRecording && !isPaused && config.continuousMode) {
                // Riavvia automaticamente se in modalit√† continua
                setTimeout(function() {
                    if (isRecording && recognition) {
                        try {
                            recognition.start();
                        } catch(e) {
                            console.log('Riavvio recognition:', e);
                        }
                    }
                }, 100);
            }
        };
        
        return true;
    }
    
    // ============================================
    // STATISTICHE LIVE
    // ============================================
    
    function updateStats() {
        // Word count
        const words = transcript.split(/\s+/).filter(function(w) { return w.length > 0; }).length;
        document.getElementById('wordCount').textContent = words;
        
        // Speaker count
        document.getElementById('speakerCount').textContent = speakers.size;
        
        // Duration
        if (sessionStartTime) {
            const duration = Math.floor((Date.now() - sessionStartTime) / 1000);
            const minutes = Math.floor(duration / 60);
            const seconds = duration % 60;
            document.getElementById('duration').textContent = 
                minutes.toString().padStart(2, '0') + ':' + seconds.toString().padStart(2, '0');
        }
        
        // Average confidence
        let totalConfidence = 0;
        let totalSegments = 0;
        speakers.forEach(function(speaker) {
            totalConfidence += speaker.totalConfidence;
            totalSegments += speaker.segments;
        });
        
        if (totalSegments > 0) {
            const avgConfidence = (totalConfidence / totalSegments * 100).toFixed(0);
            document.getElementById('confidenceAvg').textContent = avgConfidence + '%';
        }
    }
    
    // ============================================
    // REGISTRAZIONE AUDIO
    // ============================================
    
    async function startRecording() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                audio: {
                    echoCancellation: config.noiseFilter,
                    noiseSuppression: config.noiseFilter,
                    autoGainControl: true,  // Regola automaticamente il volume
                    sampleRate: 48000,      // Sample rate pi√π alto per migliore qualit√†
                    channelCount: 1,        // Mono per speech recognition
                    sampleSize: 16          // 16-bit audio
                } 
            });
            
            // Reset variabili
            recordedChunks = [];
            transcript = "";
            speakers.clear();
            currentSpeaker = 1;
            
            mediaRecorder = new MediaRecorder(stream, {
                mimeType: 'audio/webm;codecs=opus'
            });
            
            mediaRecorder.ondataavailable = function(event) {
                if (event.data.size > 0) {
                    recordedChunks.push(event.data);
                }
            };
            
            mediaRecorder.onstop = function() {
                recordedBlob = new Blob(recordedChunks, { type: 'audio/webm' });
                const url = URL.createObjectURL(recordedBlob);
                recordedAudio.src = url;
                recordedAudioSection.style.display = 'block';
                
                // Initialize waveform se disponibile
                if (typeof WaveSurfer !== 'undefined') {
                    if (wavesurfer) {
                        wavesurfer.destroy();
                    }
                    wavesurfer = WaveSurfer.create({
                        container: '#waveform',
                        waveColor: '#667eea',
                        progressColor: '#764ba2',
                        cursorColor: '#764ba2',
                        barWidth: 2,
                        barRadius: 3,
                        responsive: true,
                        height: 60,
                        normalize: true
                    });
                    wavesurfer.loadBlob(recordedBlob);
                }
            };
            
            mediaRecorder.start(1000); // Registra in chunks di 1 secondo
            isRecording = true;
            
            // Attiva Wake Lock per mantenere il dispositivo attivo
            requestWakeLock().then(function(success) {
                if (success) {
                    console.log('üîã Dispositivo manterr√† lo schermo attivo');
                } else {
                    console.log('‚ö†Ô∏è Wake Lock non disponibile, lo schermo potrebbe spegnersi');
                }
            });
            
            // Aggiorna UI
            startBtn.disabled = true;
            stopBtn.disabled = false;
            pauseBtn.disabled = false;
            saveSessionBtn.disabled = false;
            startBtn.classList.add('recording');
            
            // Inizia riconoscimento vocale
            if (initSpeechRecognition()) {
                try {
                    recognition.start();
                } catch(e) {
                    console.error('Errore avvio recognition:', e);
                    // Prova a riavviare dopo un breve delay
                    setTimeout(function() {
                        if (recognition) {
                            recognition.start();
                        }
                    }, 500);
                }
            }
            
        } catch (err) {
            console.error('Errore accesso microfono:', err);
            showStatus('‚ùå Errore accesso microfono: ' + err.message, 'error');
            
            // Reset UI in caso di errore
            startBtn.disabled = false;
            stopBtn.disabled = true;
            pauseBtn.disabled = true;
        }
    }
    
    function stopRecording() {
        isRecording = false;
        isPaused = false;
        
        // Rilascia Wake Lock
        releaseWakeLock();
        
        if (mediaRecorder &&
mediaRecorder.state !== 'inactive') {
            try {
                mediaRecorder.stop();
            } catch(e) {
                console.error('Errore stop mediaRecorder:', e);
            }
        }
        
        if (recognition) {
            try {
                recognition.stop();
            } catch(e) {
                console.error('Errore stop recognition:', e);
            }
        }
        
        // Stop all streams
        if (mediaRecorder && mediaRecorder.stream) {
            mediaRecorder.stream.getTracks().forEach(function(track) {
                track.stop();
            });
        }
        
        startBtn.disabled = false;
        stopBtn.disabled = true;
        pauseBtn.disabled = true;
        resumeBtn.style.display = 'none';
        startBtn.classList.remove('recording');
        
        visualizer.style.display = 'none';
        
        if (autoSaveInterval) {
            clearInterval(autoSaveInterval);
            autoSaveInterval = null;
        }
        
        // Save final session
        if (transcript) {
            saveCurrentSession(false);
            mainTranscript.innerHTML = liveTranscript.innerHTML;
            document.getElementById('transcriptSection').style.display = 'block';
            document.getElementById('analysisInfo').style.display = 'none';
            enableAnalysisButtons();
        }
        
        showStatus('‚èπÔ∏è Registrazione terminata', 'success');
    }
    
    function pauseRecording() {
        isPaused = true;
        
        if (mediaRecorder && mediaRecorder.state === 'recording') {
            mediaRecorder.pause();
        }
        
        if (recognition) {
            recognition.stop();
        }
        
        pauseBtn.style.display = 'none';
        resumeBtn.style.display = 'inline-flex';
        
        showStatus('‚è∏Ô∏è Registrazione in pausa', 'info');
    }
    
    function resumeRecording() {
        isPaused = false;
        
        if (mediaRecorder && mediaRecorder.state === 'paused') {
            mediaRecorder.resume();
        }
        
        if (recognition) {
            recognition.start();
        }
        
        pauseBtn.style.display = 'inline-flex';
        resumeBtn.style.display = 'none';
        
        showStatus('‚ñ∂Ô∏è Registrazione ripresa', 'info');
    }
    
    // ============================================
    // SALVATAGGIO SESSIONI
    // ============================================
    
    function saveCurrentSession(isAutoSave) {
        if (!transcript || !db) return;
        
        if (typeof isAutoSave === 'undefined') {
            isAutoSave = false;
        }
        
        const sessionId = currentSessionId || ('session_' + Date.now());
        currentSessionId = sessionId;
        
        const session = {
            id: sessionId,
            date: new Date().toISOString(),
            transcript: transcript,
            speakers: Array.from(speakers.entries()),
            language: languageSelect.value,
            duration: sessionStartTime ? Math.floor((Date.now() - sessionStartTime) / 1000) : 0,
            wordCount: transcript.split(/\s+/).length,
            html: liveTranscript.innerHTML
        };
        
        // Save to IndexedDB
        try {
            const transaction = db.transaction(['sessions'], 'readwrite');
            const store = transaction.objectStore('sessions');
            const request = store.put(session);
            
            request.onsuccess = function() {
                // Save audio if available
                if (recordedBlob && config.saveAudio) {
                    // Leggi il blob prima di creare la transazione
                    const reader = new FileReader();
                    reader.onload = function() {
                        // Crea la transazione solo dopo che il blob √® stato letto
                        try {
                            const audioTransaction = db.transaction(['audio'], 'readwrite');
                            const audioStore = audioTransaction.objectStore('audio');
                            
                            const audioRequest = audioStore.put({
                                sessionId: sessionId,
                                data: reader.result
                            });
                            
                            audioRequest.onerror = function() {
                                console.error('Errore salvataggio audio:', audioRequest.error);
                            };
                        } catch (err) {
                            console.error('Errore transazione audio:', err);
                        }
                    };
                    reader.readAsArrayBuffer(recordedBlob);
                }
                
                if (!isAutoSave) {
                    showStatus('üíæ Sessione salvata con successo!', 'success');
                }
            };
            
            request.onerror = function() {
                console.error('Errore salvataggio sessione:', request.error);
                if (!isAutoSave) {
                    showStatus('‚ùå Errore nel salvataggio', 'error');
                }
            };
        } catch (err) {
            console.error('Errore database:', err);
        }
    }
    
    function loadSessions() {
        if (!db) {
            console.error('Database non inizializzato');
            return;
        }
        
        const transaction = db.transaction(['sessions'], 'readonly');
        const store = transaction.objectStore('sessions');
        const request = store.getAll();
        
        request.onsuccess = function() {
            sessions = request.result.sort(function(a, b) {
                return new Date(b.date) - new Date(a.date);
            });
            displaySessions();
        };
        
        request.onerror = function() {
            console.error('Errore caricamento sessioni:', request.error);
        };
    }
    
    function displaySessions() {
        if (sessions.length === 0) {
            sessionsList.innerHTML = '<p style="text-align:center; color:#9ca3af;">Nessuna sessione salvata</p>';
            return;
        }
        
        sessionsList.innerHTML = '';
        sessions.forEach(function(session) {
            const sessionDiv = document.createElement('div');
            sessionDiv.className = 'session-item';
            
            const date = new Date(session.date);
            const duration = session.duration;
            const minutes = Math.floor(duration / 60);
            const seconds = duration % 60;
            
            sessionDiv.innerHTML = '<div class="session-info">' +
                '<h4>Sessione del ' + date.toLocaleDateString('it-IT') + ' ' + date.toLocaleTimeString('it-IT') + '</h4>' +
                '<div class="session-meta">' +
                'üìù ' + session.wordCount + ' parole | ‚è±Ô∏è ' + minutes + ':' + seconds.toString().padStart(2, '0') + ' | ' +
                'üë• ' + (session.speakers ? session.speakers.length : 1) + ' parlanti | üåç ' + session.language +
                '</div></div>' +
                '<div class="session-actions">' +
                '<button class="btn btn-sm btn-info" onclick="loadSession(\'' + session.id + '\')">' +
                '<span>üìÇ</span> Carica</button>' +
                '<button class="btn btn-sm btn-danger" onclick="deleteSession(\'' + session.id + '\')">' +
                '<span>üóëÔ∏è</span></button></div>';
            
            sessionsList.appendChild(sessionDiv);
        });
    }
    
    window.loadSession = function(sessionId) {
        const transaction = db.transaction(['sessions', 'audio'], 'readonly');
        const sessionStore = transaction.objectStore('sessions');
        const sessionRequest = sessionStore.get(sessionId);
        
        sessionRequest.onsuccess = function() {
            const session = sessionRequest.result;
            if (session) {
                // Load transcript
                transcript = session.transcript;
                mainTranscript.innerHTML = session.html || session.transcript;
                document.getElementById('transcriptSection').style.display = 'block';
                document.getElementById('analysisInfo').style.display = 'none';
                
                // Load speakers
                speakers = new Map(session.speakers || []);
                
                // Load audio if available
                const audioStore = transaction.objectStore('audio');
                const audioRequest = audioStore.get(sessionId);
                
                audioRequest.onsuccess = function() {
                    const audioData = audioRequest.result;
                    if (audioData && audioData.data) {
                        const blob = new Blob([audioData.data], { type: 'audio/webm' });
                        const url = URL.createObjectURL(blob);
                        recordedAudio.src = url;
                        recordedAudioSection.style.display = 'block';
                    }
                };
                
                // Switch to analysis tab
                tabs.forEach(function(t) { t.classList.remove('active'); });
                tabContents.forEach(function(tc) { tc.classList.remove('active'); });
                document.querySelector('[data-tab="analysis"]').classList.add('active');
                document.getElementById('tab-analysis').classList.add('active');
                
                enableAnalysisButtons();
                showStatus('üìÇ Sessione caricata con successo!', 'success');
            }
        };
    };
    
    window.deleteSession = function(sessionId) {
        if (!confirm('Sei sicuro di voler eliminare questa sessione?')) return;
        
        const transaction = db.transaction(['sessions', 'audio'], 'readwrite');
        
        const sessionStore = transaction.objectStore('sessions');
        sessionStore.delete(sessionId);
        
        const audioStore = transaction.objectStore('audio');
        audioStore.delete(sessionId);
        
        transaction.oncomplete = function() {
            loadSessions();
            showStatus('üóëÔ∏è Sessione eliminata', 'info');
        };
    };
    
    // ============================================
    // FILE UPLOAD
    // ============================================
    
    uploadArea.addEventListener('click', function() {
        audioFile.click();
    });
    
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', function() {
        uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0 && files[0].type.startsWith('audio/')) {
            handleAudioFile(files[0]);
        }
    });
    
    audioFile.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
            handleAudioFile(e.target.files[0]);
        }
    });
    
    async function handleAudioFile(file) {
        if (file.size > 100 * 1024 * 1024) {
            showStatus('‚ùå File troppo grande (max 100MB)', 'error');
            return;
        }
        
        const key = groqApiKey.value.trim();
        if (!key) {
            showStatus('‚ùå Inserisci la tua API Key Groq per trascrivere il file audio', 'error');
            return;
        }
        
        showStatus('üéôÔ∏è Trascrizione audio in corso con Groq Whisper...', 'loading');
        
        const progressContainer = document.getElementById('uploadProgress');
        const progressFill = document.getElementById('progressFill');
        const progressPercent = document.getElementById('progressPercent');
        
        progressContainer.style.display = 'block';
        progressFill.style.width = '20%';
        progressPercent.textContent = '20%';
        
        try {
            // Crea FormData in modo sicuro
            const formData = new FormData();
            
            // Crea un nuovo Blob dal file per evitare problemi di clonazione
            const fileBlob = new Blob([file], { type: file.type });
            formData.append('file', fileBlob, file.name);
            formData.append('model', 'whisper-large-v3');
            formData.append('response_format', 'verbose_json');
            
            // Estrai solo il codice lingua (es: 'it' da 'it-IT')
            const langCode = languageSelect.value.split('-')[0];
            formData.append('language', langCode);
            
            progressFill.style.width = '40%';
            progressPercent.textContent = '40%';
            
            console.log('üì§ Invio file a Groq Whisper API...');
            
            // Chiama Groq Whisper API
            // Non specificare Content-Type, lascia che fetch lo gestisca automaticamente
            const res = await fetch('https://api.groq.com/openai/v1/audio/transcriptions', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + key
                    // NON includere Content-Type - fetch lo gestisce automaticamente con FormData
                },
                body: formData
            });
            
            progressFill.style.width = '70%';
            progressPercent.textContent = '70%';
            
            if (!res.ok) {
                const errorText = await res.text();
                console.error('Errore API:', errorText);
                throw new Error('Errore API Groq Whisper: ' + res.status + ' - ' + res.statusText);
            }
            
            const data = await res.json();
            console.log('‚úÖ Risposta ricevuta da Groq Whisper');
            
            progressFill.style.width = '90%';
            progressPercent.textContent = '90%';
            
            // Processa il risultato
            let transcribedText = data.text || '';
            
            // Se ci sono segmenti con speaker diarization, usali
            if (data.segments && data.segments.length > 0) {
                // Raggruppa segmenti per parlante (simulato)
                transcribedText = '';
                let lastSpeaker = 1;
                
                data.segments.forEach(function(segment, index) {
                    // Cambia parlante ogni 2-3 segmenti (simulazione)
                    if (index % 3 === 0 && index > 0) {
                        lastSpeaker = lastSpeaker === config.maxSpeakers ? 1 : lastSpeaker + 1;
                    }
                    transcribedText += '[Parlante ' + lastSpeaker + ']: ' + segment.text.trim() + '\n';
                });
            } else {
                // Nessun segmento, usa il testo completo
                transcribedText = '[Parlante 1]: ' + transcribedText;
            }
            
            progressFill.style.width = '100%';
            progressPercent.textContent = '100%';
            
            // Mostra il risultato
            setTimeout(function() {
                progressContainer.style.display = 'none';
                
                // Crea segmenti visuali
                const lines = transcribedText.split('\n').filter(function(l) { return l.trim(); });
                const fileTranscriptDiv = document.getElementById('fileTranscript');
                fileTranscriptDiv.innerHTML = '';
                
                lines.forEach(function(line) {
                    const match = line.match(/\[Parlante (\d+)\]: (.+)/);
                    if (match) {
                        const speakerId = parseInt(match[1]);
                        const text = match[2];
                        const segment = createSpeakerSegment(text, speakerId, 0.95);
                        fileTranscriptDiv.appendChild(segment);
                    } else if (line.trim()) {
                        const segment = createSpeakerSegment(line, 1, 0.95);
                        fileTranscriptDiv.appendChild(segment);
                    }
                });
mainTranscript.innerHTML
document.getElementById('transcriptSection').style.display = 'block';
                document.getElementById('analysisInfo').style.display = 'none';
                enableAnalysisButtons();
                
                showStatus('‚úÖ Trascrizione completata! (' + file.name + ')', 'success');
            }, 500);
            
        } catch (err) {
            progressContainer.style.display = 'none';
            console.error('Errore trascrizione:', err);
            showStatus('‚ùå Errore trascrizione: ' + err.message, 'error');
        }
    }
    
    // ============================================
    // TRASCRIZIONE LIVE FILE AUDIO
    // ============================================
    
    async function startLiveFileTranscription() {
        if (isLiveTranscribing) {
            showStatus('‚ö†Ô∏è Trascrizione gi√† in corso', 'warning');
            return;
        }
        
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
            showStatus('‚ùå Il tuo browser non supporta il riconoscimento vocale', 'error');
            return;
        }
        
        try {
            // Richiedi accesso al microfono
            await navigator.mediaDevices.getUserMedia({ audio: true });
            
            const SpeechRecognition = window.webkitSpeechRecognition || window.SpeechRecognition;
            liveFileRecognition = new SpeechRecognition();
            
            liveFileRecognition.continuous = true;
            liveFileRecognition.interimResults = true;
            liveFileRecognition.maxAlternatives = 5;
            liveFileRecognition.lang = languageSelect.value;
            
            const fileTranscriptDiv = document.getElementById('fileTranscript');
            fileTranscriptDiv.classList.remove('empty');
            if (fileTranscriptDiv.textContent === 'La trascrizione apparir√† qui...') {
                fileTranscriptDiv.innerHTML = '';
            }
            
            liveFileRecognition.onstart = function() {
                isLiveTranscribing = true;
                startLiveTranscriptionBtn.disabled = true;
                startLiveTranscriptionBtn.style.display = 'none';
                stopLiveTranscriptionBtn.disabled = false;
                stopLiveTranscriptionBtn.style.display = 'inline-flex';
                showStatus('üé§ Trascrizione live attiva - Riproduci il file audio!', 'loading');
                console.log('üé§ Trascrizione live avviata per file audio');
            };
            
            liveFileRecognition.onresult = function(event) {
                let interimText = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const result = event.results[i];
                    
                    let bestTranscript = result[0].transcript;
                    let bestConfidence = result[0].confidence || 0.5;
                    
                    for (let j = 1; j < result.length && j < 3; j++) {
                        const altConfidence = result[j].confidence || 0;
                        if (altConfidence > bestConfidence) {
                            bestTranscript = result[j].transcript;
                            bestConfidence = altConfidence;
                        }
                    }
                    
                    const transcriptText = bestTranscript.trim();
                    const confidence = bestConfidence;
                    
                    if (result.isFinal) {
                        console.log('‚úÖ Testo dal file:', transcriptText, '| Confidenza:', (confidence * 100).toFixed(0) + '%');
                        
                        // Rimuovi testo interim
                        const interimDiv = document.getElementById('interimTextFile');
                        if (interimDiv) {
                            interimDiv.remove();
                        }
                        
                        // Rileva cambio parlante
                        const speakerId = detectSpeakerChange(transcriptText, confidence);
                        
                        // Aggiungi segmento
                        const segment = createSpeakerSegment(transcriptText, speakerId, confidence);
                        fileTranscriptDiv.appendChild(segment);
                        
                        // Aggiorna transcript globale
                        transcript += '[Parlante ' + speakerId + ']: ' + transcriptText + '\n';
                        
                        // Aggiorna anche il transcript principale
                        mainTranscript.innerHTML = fileTranscriptDiv.innerHTML;
                        document.getElementById('transcriptSection').style.display = 'block';
                        document.getElementById('analysisInfo').style.display = 'none';
                        enableAnalysisButtons();
                        
                        // Auto scroll
                        fileTranscriptDiv.scrollTop = fileTranscriptDiv.scrollHeight;
                        
                    } else {
                        interimText += transcriptText;
                    }
                }
                
                // Mostra risultati interim
                if (interimText) {
                    let tempDiv = document.getElementById('interimTextFile');
                    if (!tempDiv) {
                        tempDiv = document.createElement('div');
                        tempDiv.id = 'interimTextFile';
                        tempDiv.style.opacity = '0.7';
                        tempDiv.style.fontStyle = 'italic';
                        tempDiv.style.color = '#667eea';
                        tempDiv.style.padding = '10px';
                        fileTranscriptDiv.appendChild(tempDiv);
                    }
                    tempDiv.textContent = 'üé§ ' + interimText;
                    fileTranscriptDiv.scrollTop = fileTranscriptDiv.scrollHeight;
                }
            };
            
            liveFileRecognition.onerror = function(event) {
                console.error('Errore trascrizione live:', event.error);
                
                if (event.error === 'no-speech') {
                    // Normale, non mostrare errore
                } else if (event.error === 'audio-capture') {
                    showStatus('‚ùå Errore microfono', 'error');
                    stopLiveFileTranscription();
                } else if (event.error === 'not-allowed') {
                    showStatus('‚ùå Permesso microfono negato', 'error');
                    stopLiveFileTranscription();
                } else {
                    showStatus('‚ùå Errore: ' + event.error, 'error');
                }
            };
            
            liveFileRecognition.onend = function() {
                if (isLiveTranscribing) {
                    // Riavvia automaticamente
                    setTimeout(function() {
                        if (isLiveTranscribing && liveFileRecognition) {
                            try {
                                liveFileRecognition.start();
                            } catch(e) {
                                console.log('Riavvio trascrizione live:', e);
                            }
                        }
                    }, 100);
                }
            };
            
            liveFileRecognition.start();
            
        } catch (err) {
            console.error('Errore avvio trascrizione live:', err);
            showStatus('‚ùå Errore accesso microfono: ' + err.message, 'error');
        }
    }
    
    function stopLiveFileTranscription() {
        isLiveTranscribing = false;
        
        if (liveFileRecognition) {
            try {
                liveFileRecognition.stop();
            } catch(e) {
                console.error('Errore stop trascrizione live:', e);
            }
            liveFileRecognition = null;
        }
        
        // Rimuovi testo interim
        const interimDiv = document.getElementById('interimTextFile');
        if (interimDiv) {
            interimDiv.remove();
        }
        
        startLiveTranscriptionBtn.disabled = false;
        startLiveTranscriptionBtn.style.display = 'inline-flex';
        stopLiveTranscriptionBtn.disabled = true;
        stopLiveTranscriptionBtn.style.display = 'none';
        
        showStatus('‚èπÔ∏è Trascrizione live fermata', 'info');
    }
    
    // ============================================
    // ANALISI AI (GROQ)
    // ============================================
    
    function enableAnalysisButtons() {
        correctTextBtn.disabled = false;
        summarizeBtn.disabled = false;
        analyzeBtn.disabled = false;
        sentimentBtn.disabled = false;
        keywordsBtn.disabled = false;
        actionItemsBtn.disabled = false;
        exportPdfBtn.disabled = false;
        exportTxtBtn.disabled = false;
        exportJsonBtn.disabled = false;
        exportDocxBtn.disabled = false;
    }
    
    async function callGroqAPI(prompt) {
        const key = groqApiKey.value.trim();
        if (!key) {
            showStatus('‚ùå Inserisci la tua API Key Groq', 'error');
            return null;
        }
        
        showStatus('ü§ñ Analisi AI in corso...', 'loading');
        
        try {
            const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + key,
                },
                body: JSON.stringify({
                    model: 'llama-3.1-70b-versatile',
                    messages: [{ role: 'user', content: prompt }],
                    temperature: 0.7,
                    max_tokens: 4096,
                }),
            });
            
            if (!res.ok) {
                throw new Error('Errore API: ' + res.status);
            }
            
            const data = await res.json();
            return data.choices[0].message.content;
        } catch (err) {
            showStatus('‚ùå Errore Groq: ' + err.message, 'error');
            return null;
        }
    }
    
    function addAnalysisSection(title, content, icon) {
        if (!icon) icon = 'üìä';
        
        const div = document.createElement('div');
        div.className = 'analysis-section';
        div.innerHTML = '<h3>' + icon + ' ' + title + '</h3>' +
            '<div class="analysis-content">' + content.replace(/\n/g, '<br>') + '</div>';
        analysisResults.prepend(div);
        showStatus('‚ú® Analisi completata!', 'success');
    }
    
    // Event listeners per bottoni di analisi
    correctTextBtn.addEventListener('click', async function() {
        const text = transcript || mainTranscript.textContent;
        if (!text) return;
const prompt = 'Correggi grammatica, punteggiatura e ortografia del seguente testo mantenendo l\'identificazione dei parlanti. Restituisci SOLO il testo corretto:\n\n' + text;
        
        const result = await callGroqAPI(prompt);
        if (!result) return;
        
        transcript = result.trim();
        // Parse and display with speaker colors
        const lines = result.split('\n');
        mainTranscript.innerHTML = '';
        lines.forEach(function(line) {
            const match = line.match(/\[Parlante (\d+)\]: (.*)/);
            if (match) {
                const segment = createSpeakerSegment(match[2], parseInt(match[1]), 1);
                mainTranscript.appendChild(segment);
            } else if (line.trim()) {
                const p = document.createElement('p');
                p.textContent = line;
                mainTranscript.appendChild(p);
            }
        });
        
        showStatus('‚ú® Testo corretto!', 'success');
    });
    
    summarizeBtn.addEventListener('click', async function() {
        const text = transcript || mainTranscript.textContent;
        if (!text) return;
        
        const prompt = 'Crea un riassunto dettagliato del seguente testo identificando i punti principali di ogni parlante. Usa un formato strutturato:\n\n' + text;
        const result = await callGroqAPI(prompt);
        
        if (result) addAnalysisSection('Riassunto Dettagliato', result, 'üìù');
    });
    
    analyzeBtn.addEventListener('click', async function() {
        const text = transcript || mainTranscript.textContent;
        if (!text) return;
        
        const prompt = 'Analizza in modo approfondito questa conversazione:\n' +
            '1. Identificazione dei parlanti e loro ruoli\n' +
            '2. Tema principale e argomenti discussi\n' +
            '3. Tono e dinamiche della conversazione\n' +
            '4. Punti chiave per ogni parlante\n' +
            '5. Conclusioni e azioni suggerite\n\n' +
            'Testo:\n' + text;
        
        const result = await callGroqAPI(prompt);
        if (result) addAnalysisSection('Analisi Completa della Conversazione', result, 'üîç');
    });
    
    sentimentBtn.addEventListener('click', async function() {
        const text = transcript || mainTranscript.textContent;
        if (!text) return;
        
        const prompt = 'Analizza il sentiment e le emozioni in questa conversazione per ogni parlante. Identifica:\n' +
            '1. Sentiment generale (positivo/negativo/neutro)\n' +
            '2. Emozioni principali espresse\n' +
            '3. Cambiamenti di tono durante la conversazione\n' +
            '4. Livello di accordo/disaccordo tra parlanti\n\n' +
            'Testo:\n' + text;
        
        const result = await callGroqAPI(prompt);
        if (result) addAnalysisSection('Analisi del Sentiment', result, 'üòä');
    });
    
    keywordsBtn.addEventListener('click', async function() {
        const text = transcript || mainTranscript.textContent;
        if (!text) return;
        
        const prompt = 'Estrai le parole chiave e i concetti principali da questa conversazione. Organizza per:\n' +
            '1. Keywords principali (10-15)\n' +
            '2. Argomenti ricorrenti\n' +
            '3. Termini tecnici o specialistici\n' +
            '4. Nomi propri e riferimenti\n\n' +
            'Testo:\n' + text;
        
        const result = await callGroqAPI(prompt);
        if (result) addAnalysisSection('Parole Chiave e Concetti', result, 'üè∑Ô∏è');
    });
    
    actionItemsBtn.addEventListener('click', async function() {
        const text = transcript || mainTranscript.textContent;
        if (!text) return;
        
        const prompt = 'Identifica tutti gli action items, task e impegni presi in questa conversazione. Per ogni item specifica:\n' +
            '1. Descrizione dell\'azione\n' +
            '2. Chi √® responsabile (quale parlante)\n' +
            '3. Scadenza o tempistica (se menzionata)\n' +
            '4. Priorit√† suggerita\n\n' +
            'Testo:\n' + text;
        
        const result = await callGroqAPI(prompt);
        if (result) addAnalysisSection('Action Items e Task', result, '‚úÖ');
    });
    
    // ============================================
    // ESPORTAZIONE
    // ============================================
    
    exportPdfBtn.addEventListener('click', function() {
        const text = transcript || mainTranscript.textContent;
        if (!text) return;
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Header
        doc.setFontSize(20);
        doc.setTextColor(102, 126, 234);
        doc.text('Trascrizione Audio Pro', 15, 20);
        
        doc.setFontSize(10);
        doc.setTextColor(0);
        doc.text('Data: ' + new Date().toLocaleDateString('it-IT') + ' ' + new Date().toLocaleTimeString('it-IT'), 15, 30);
        doc.text('Parlanti: ' + (speakers.size || 1) + ' | Parole: ' + text.split(/\s+/).length, 15, 35);
        
        // Content
        doc.setFontSize(12);
        const lines = doc.splitTextToSize(text, 180);
        let y = 45;
        
        lines.forEach(function(line) {
            if (y > 270) {
                doc.addPage();
                y = 20;
            }
            doc.text(line, 15, y);
            y += 7;
        });
        
        doc.save('trascrizione_' + Date.now() + '.pdf');
        showStatus('üìÑ PDF salvato!', 'success');
    });
    
    exportTxtBtn.addEventListener('click', function() {
        const text = transcript || mainTranscript.textContent;
        if (!text) return;
        
        const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
        saveAs(blob, 'trascrizione_' + Date.now() + '.txt');
        showStatus('üìù TXT salvato!', 'success');
    });
    
    exportJsonBtn.addEventListener('click', function() {
        const data = {
            date: new Date().toISOString(),
            language: languageSelect.value,
            transcript: transcript || mainTranscript.textContent,
            speakers: Array.from(speakers.entries()),
            wordCount: (transcript || mainTranscript.textContent).split(/\s+/).length,
            analyses: []
        };
        
        // Add analyses if available
        const analysisSections = analysisResults.querySelectorAll('.analysis-section');
        analysisSections.forEach(function(section) {
            const title = section.querySelector('h3').textContent;
            const content = section.querySelector('.analysis-content').textContent;
            data.analyses.push({ title: title, content: content });
        });
        
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        saveAs(blob, 'trascrizione_' + Date.now() + '.json');
        showStatus('üíæ JSON salvato!', 'success');
    });
    
    exportDocxBtn.addEventListener('click', function() {
        // For DOCX export, we'd need a library like docx.js
        // For now, export as HTML that can be opened in Word
        const text = transcript || mainTranscript.textContent;
        if (!text) return;
        
        const html = '<!DOCTYPE html><html><head><meta charset="UTF-8">' +
            '<title>Trascrizione Audio</title>' +
            '<style>' +
            'body { font-family: Arial, sans-serif; line-height: 1.6; max-width: 800px; margin: 0 auto; padding: 20px; }' +
            'h1 { color: #667eea; }' +
            '.speaker-1 { color: #3b82f6; font-weight: bold; }' +
            '.speaker-2 { color: #10b981; font-weight: bold; }' +
            '.speaker-3 { color: #f59e0b; font-weight: bold; }' +
            '.speaker-4 { color: #ef4444; font-weight: bold; }' +
            '.speaker-5 { color: #8b5cf6; font-weight: bold; }' +
            '.segment { margin: 15px 0; padding: 10px; border-left: 3px solid #e5e7eb; }' +
            '</style></head><body>' +
            '<h1>Trascrizione Audio Pro</h1>' +
            '<p><strong>Data:</strong> ' + new Date().toLocaleDateString('it-IT') + ' ' + new Date().toLocaleTimeString('it-IT') + '</p>' +
            '<p><strong>Parlanti:</strong> ' + (speakers.size || 1) + ' | <strong>Parole:</strong> ' + text.split(/\s+/).length + '</p>' +
            '<hr>' + mainTranscript.innerHTML +
            '</body></html>';
        
        const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
        saveAs(blob, 'trascrizione_' + Date.now() + '.html');
        showStatus('üìò Documento salvato (apribile in Word)!', 'success');
    });
    
    // ============================================
    // IMPOSTAZIONI
    // ============================================
    
    // Toggle switches
    continuousToggle.addEventListener('click', function() {
        continuousToggle.classList.toggle('active');
        config.continuousMode = continuousToggle.classList.contains('active');
        if (recognition) {
            recognition.continuous = config.continuousMode;
        }
    });
    
    speakerDetectionToggle.addEventListener('click', function() {
        speakerDetectionToggle.classList.toggle('active');
        config.speakerDetection = speakerDetectionToggle.classList.contains('active');
    });
    
    autoPunctuationToggle.addEventListener('click', function() {
        autoPunctuationToggle.classList.toggle('active');
        config.autoPunctuation = autoPunctuationToggle.classList.contains('active');
    });
    
    noiseFilterToggle.addEventListener('click', function() {
        noiseFilterToggle.classList.toggle('active');
        config.noiseFilter = noiseFilterToggle.classList.contains('active');
    });
    
    autoSaveToggle.addEventListener('click', function() {
        autoSaveToggle.classList.toggle('active');
        config.autoSave = autoSaveToggle.classList.contains('active');
    });
    
    saveAudioToggle.addEventListener('click', function() {
        saveAudioToggle.classList.toggle('active');
        config.saveAudio = saveAudioToggle.classList.contains('active');
    });
    
    // Settings inputs
    document.getElementById('confidenceThreshold').addEventListener('input', function(e) {
        config.confidenceThreshold = e.target.value / 100;
        document.getElementById('confidenceValue').textContent = e.target.value + '%';
    });
    
    document.getElementById('maxSpeakers').addEventListener('change', function(e) {
        config.maxSpeakers = parseInt(e.target.value);
    });
    
    document.getElementById('speakerPause').addEventListener('change', function(e) {
        config.speakerPauseThreshold = parseInt(e.target.value);
    });
    
    document.getElementById('autoSaveInterval').addEventListener('change', function(e) {
        config.autoSaveIntervalSec = parseInt(e.target.value);
    });
    
    // Save settings
    document.getElementById('saveSettingsBtn').addEventListener('click', function() {
        localStorage.setItem('transcriptionConfig', JSON.stringify(config));
        
        // Save speaker colors
        for (let i = 1; i <= 5; i++) {
            const colorInput = document.getElementById('speaker' + i + 'Color');
            if (colorInput) {
                const color = colorInput.value;
                speakerColors[i] = color;
            }
        }
        localStorage.setItem('speakerColors', JSON.stringify(speakerColors));
        
        showStatus('‚úÖ Impostazioni salvate!', 'success');
    });
    
    // ============================================
    // LIVE FILE TRANSCRIPTION
    // ============================================
    
    startLiveTranscriptionBtn.addEventListener('click', startLiveFileTranscription);
    stopLiveTranscriptionBtn.addEventListener('click', stopLiveFileTranscription);
    
    // ============================================
    // TEXT ANALYSIS
    // ============================================
    document.getElementById('analyzeTextBtn').addEventListener('click', function() {
        const text = pastedText.value.trim();
        if (!text) {
            showStatus('‚ö†Ô∏è Inserisci del testo da analizzare', 'error');
            return;
        }
        
        transcript = text;
        mainTranscript.textContent = text;
        document.getElementById('transcriptSection').style.display = 'block';
        document.getElementById('analysisInfo').style.display = 'none';
        enableAnalysisButtons();
        
        // Switch to analysis tab
        tabs.forEach(function(t) { t.classList.remove('active'); });
        tabContents.forEach(function(tc) { tc.classList.remove('active'); });
        document.querySelector('[data-tab="analysis"]').classList.add('active');
        document.getElementById('tab-analysis').classList.add('active');
        
        showStatus('üìÑ Testo caricato per l\'analisi!', 'success');
    });
    
    document.getElementById('identifySpeakersTextBtn').addEventListener('click', async function() {
        const text = pastedText.value.trim();
        if (!text) {
            showStatus('‚ö†Ô∏è Inserisci del testo', 'error');
            return;
        }
        
        const prompt = 'Analizza il seguente testo e identifica i diversi parlanti. ' +
            'Riformatta il testo aggiungendo [Parlante X]: prima di ogni intervento. ' +
            'Se non ci sono parlanti chiari, suggerisci una possibile divisione basata sul contesto:\n\n' + text;
        
        const result = await callGroqAPI(prompt);
        if (result) {
            pastedText.value = result;
            showStatus('üë• Parlanti identificati!', 'success');
        }
    });
    
    document.getElementById('clearTextBtn').addEventListener('click', function() {
        pastedText.value = '';
        showStatus('üóëÔ∏è Testo cancellato', 'info');
    });
    
    // ============================================
    // HISTORY MANAGEMENT
    // ============================================
    
    document.getElementById('refreshHistoryBtn').addEventListener('click', function() {
        loadSessions();
        showStatus('üîÑ Lista aggiornata', 'info');
    });
    
    document.getElementById('clearHistoryBtn').addEventListener('click', function() {
        if (!confirm('‚ö†Ô∏è Sei sicuro di voler cancellare TUTTE le sessioni salvate? Questa azione non pu√≤ essere annullata.')) {
            return;
        }
        
        if (!db) {
            showStatus('‚ùå Database non inizializzato', 'error');
            return;
        }
        
        const transaction = db.transaction(['sessions', 'audio'], 'readwrite');
        
        const sessionStore = transaction.objectStore('sessions');
        sessionStore.clear();
        
        const audioStore = transaction.objectStore('audio');
        audioStore.clear();
        
        transaction.oncomplete = function() {
            sessions = [];
            displaySessions();
            showStatus('üóëÔ∏è Tutte le sessioni cancellate', 'info');
        };
    });
    
    document.getElementById('exportAllBtn').addEventListener('click', function() {
        if (sessions.length === 0) {
            showStatus('‚ö†Ô∏è Nessuna sessione da esportare', 'warning');
            return;
        }
        
        const exportData = {
            exportDate: new Date().toISOString(),
            totalSessions: sessions.length,
            sessions: sessions
        };
        
        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        saveAs(blob, 'all_sessions_' + Date.now() + '.json');
        showStatus('üì¶ Tutte le sessioni esportate!', 'success');
    });
    
    // ============================================
    // EVENT LISTENERS
    // ============================================
    
    startBtn.addEventListener('click', startRecording);
    stopBtn.addEventListener('click', stopRecording);
    pauseBtn.addEventListener('click', pauseRecording);
    resumeBtn.addEventListener('click', resumeRecording);
    saveSessionBtn.addEventListener('click', function() {
        saveCurrentSession(false);
    });
    
    languageSelect.addEventListener('change', function() {
        if (recognition) {
            recognition.lang = languageSelect.value;
        }
    });
    
    // ============================================
    // UTILITY FUNCTIONS
    // ============================================
    
    function showStatus(msg, type) {
        statusDiv.className = 'status active ' + type;
        statusDiv.innerHTML = 
            type === 'loading' 
            ? '<div class="spinner"></div><span>' + msg + '</span>'
            : msg;
        
        if (type !== 'loading') {
            setTimeout(function() { statusDiv.classList.remove('active'); }, 4000);
        }
    }
    
    // ============================================
    // INIZIALIZZAZIONE
    // ============================================
    
    window.addEventListener('load', function() {
        // Initialize database
        initDB().then(function() {
            console.log('Database inizializzato');
            
            // Load saved settings
            const savedConfig = localStorage.getItem('transcriptionConfig');
            if (savedConfig) {
                try {
                    Object.assign(config, JSON.parse(savedConfig));
                    
                    // Update UI
                    document.getElementById('confidenceThreshold').value = config.confidenceThreshold * 100;
                    document.getElementById('confidenceValue').textContent = (config.confidenceThreshold * 100) + '%';
                    document.getElementById('maxSpeakers').value = config.maxSpeakers;
                    document.getElementById('speakerPause').value = config.speakerPauseThreshold;
                    document.getElementById('autoSaveInterval').value = config.autoSaveIntervalSec;
                    
                    // Update toggles
                    if (!config.continuousMode) continuousToggle.classList.remove('active');
                    if (!config.speakerDetection) speakerDetectionToggle.classList.remove('active');
                    if (!config.autoPunctuation) autoPunctuationToggle.classList.remove('active');
                    if (!config.noiseFilter) noiseFilterToggle.classList.remove('active');
                    if (!config.autoSave) autoSaveToggle.classList.remove('active');
                    if (!config.saveAudio) saveAudioToggle.classList.remove('active');
                } catch (e) {
                    console.error('Errore caricamento impostazioni:', e);
                }
            }
            
            // Load speaker colors
            const savedColors = localStorage.getItem('speakerColors');
            if (savedColors) {
                try {
                    speakerColors = JSON.parse(savedColors);
                    for (let i = 1; i <= 5; i++) {
                        if (speakerColors[i]) {
                            const colorInput = document.getElementById('speaker' + i + 'Color');
                            if (colorInput) {
                                colorInput.value = speakerColors[i];
                            }
                            
                            // Update CSS
                            const style = document.createElement('style');
                            style.textContent = '.speaker-' + i + ' { background: ' + speakerColors[i] + '; } ' +
                                '.transcript-segment.speaker-' + i + '-segment { border-left-color: ' + speakerColors[i] + '; }';
                            document.head.appendChild(style);
                        }
                    }
                } catch (e) {
                    console.error('Errore caricamento colori:', e);
                }
            }
            
            // Load saved API key
            const savedKey = localStorage.getItem('groqKey');
            if (savedKey) {
                groqApiKey.value = savedKey;
            }
            
            // Check browser compatibility
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                showStatus('‚ö†Ô∏è Il tuo browser non supporta il riconoscimento vocale. Usa Chrome, Edge o Safari.', 'warning');
                startBtn.disabled = true;
            }
            
            // Load sessions
            setTimeout(function() {
                loadSessions();
            }, 500);
            
            console.log('üéôÔ∏è Trascrizione Audio Pro - Inizializzazione completata');
        }).catch(function(err) {
            console.error('Errore inizializzazione database:', err);
            showStatus('‚ùå Errore inizializzazione database', 'error');
        });
    });
    </script>
</body>
</html>
